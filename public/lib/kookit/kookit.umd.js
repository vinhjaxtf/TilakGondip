!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Kookit={})}(this,function(t){"use strict";function n(t,s,a,h){return new(a=a||Promise)(function(i,e){function r(t){try{o(h.next(t))}catch(t){e(t)}}function n(t){try{o(h.throw(t))}catch(t){e(t)}}function o(t){var e;t.done?i(t.value):((e=t.value)instanceof a?e:new a(function(t){t(e)})).then(r,n)}o((h=h.apply(t,s||[])).next())})}class s{static getKookitConfig(t){return(JSON.parse(localStorage.getItem("kookitConfig"))||{})[t]}static setKookitConfig(t,e){let i=JSON.parse(localStorage.getItem("kookitConfig"))||{};i[t]=e,localStorage.setItem("kookitConfig",JSON.stringify(i))}static removeKookitConfig(){localStorage.removeItem("kookitConfig")}}let r=["章","节","回","節","卷","部","輯","辑","話","集","话","篇"];String.prototype.contains=function(t){return-1<this.indexOf(t)};const a=(t,e=!1)=>t&&!t.contains("[")&&!t.contains("(")&&!t.contains("。")&&!t.contains("“")&&!t.contains("‘")&&!t.contains("；")&&!t.contains(";")&&!t.contains("…")&&(t.startsWith("CHAPTER")||t.startsWith("Chapter")||t.startsWith("序章")||t.startsWith("前言")||t.startsWith("声明")||t.startsWith("聲明")||t.startsWith("写在前面的话")||t.startsWith("后记")||t.startsWith("楔子")||t.startsWith("后序")||t.startsWith("寫在前面的話")||t.startsWith("後記")||t.startsWith("後序")||t.startsWith("第")&&i(t)||t.startsWith("卷")&&o(t)||!e&&t.contains("第")&&(" "===t[t.indexOf("第")-1]||"　"===t[t.indexOf("第")-1]||"、"===t[t.indexOf("第")-1]||"："===t[t.indexOf("第")-1]||":"===t[t.indexOf("第")-1])&&i(t.substr(t.indexOf("第")))||!e&&t.indexOf(" ")&&h(t)||!e&&t.indexOf("　")&&h(t)||!e&&t.indexOf("、")&&c(t)||!e&&t.indexOf("：")&&l(t)||!e&&t.indexOf(":")&&l(t)),i=e=>{let i=!1;for(let t=0;t<r.length&&(!(-1<e.indexOf(r[t])&&(" "===e[e.indexOf(r[t])+1]||"　"===e[e.indexOf(r[t])+1]||"、"===e[e.indexOf(r[t])+1]||"："===e[e.indexOf(r[t])+1]||-1<e.indexOf("章")||":"===e[e.indexOf(r[t])+1]))&&e[e.indexOf(r[t])+1]||((/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(e.substring(1,e.indexOf(r[t])).trim())||/^\d+$/.test(e.substring(1,e.indexOf(r[t])).trim()))&&(i=!0),!i));t++);return i},o=t=>!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(t.substring(1,t.indexOf(" ")))&&!/^\d+$/.test(t.substring(1,t.indexOf(" "))))||(!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(t.substring(1,t.indexOf("　")))&&!/^\d+$/.test(t.substring(1,t.indexOf("　"))))||!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(t.substring(1))&&!/^\d+$/.test(t.substring(1)))),h=t=>!!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(t.substring(0,t.indexOf(" ")))||(!!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(t.substring(0,t.indexOf("　")))||(!!/^\d+$/.test(t.substring(0,t.indexOf(" ")))||!!/^\d+$/.test(t.substring(0,t.indexOf("　"))))),l=t=>!!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(t.substring(0,t.indexOf(":")))||(!!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(t.substring(0,t.indexOf("：")))||(!!/^\d+$/.test(t.substring(0,t.indexOf(":")))||!!/^\d+$/.test(t.substring(0,t.indexOf("："))))),c=t=>!!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(t.substring(0,t.indexOf("、")))||!!/^\d+$/.test(t.substring(0,t.indexOf("、")));var u=window;var e=window.atob("ZG8gUmU=");String.prototype.c=function(t){return-1<this.indexOf(t)};const f=()=>n(void 0,void 0,void 0,function*(){s.removeKookitConfig();let t=yield new Promise((t,e)=>{t(u.e(u.a("ZG9jdW1lbnQudGl0bGU=")))});return!!t.c(e)});var d="1.13.1",m="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||Function("return this")()||{},p=Array.prototype,g=Object.prototype,b="undefined"!=typeof Symbol?Symbol.prototype:null,v=p.push,y=p.slice,w=g.toString,x=g.hasOwnProperty,L="undefined"!=typeof ArrayBuffer,T="undefined"!=typeof DataView,k=Array.isArray,_=Object.keys,D=Object.create,C=L&&ArrayBuffer.isView,S=isNaN,O=isFinite,A=!{toString:null}.propertyIsEnumerable("toString"),M=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],U=Math.pow(2,53)-1;function E(n,o){return o=null==o?n.length-1:+o,function(){for(var t=Math.max(arguments.length-o,0),e=Array(t),i=0;i<t;i++)e[i]=arguments[i+o];switch(o){case 0:return n.call(this,e);case 1:return n.call(this,arguments[0],e);case 2:return n.call(this,arguments[0],arguments[1],e)}for(var r=Array(o+1),i=0;i<o;i++)r[i]=arguments[i];return r[o]=e,n.apply(this,r)}}function j(t){var e=typeof t;return"function"==e||"object"==e&&!!t}function N(t){return void 0===t}function W(t){return!0===t||!1===t||"[object Boolean]"===w.call(t)}function B(t){var e="[object "+t+"]";return function(t){return w.call(t)===e}}var I=B("String"),z=B("Number"),K=B("Date"),H=B("RegExp"),P=B("Error"),$=B("Symbol"),R=B("ArrayBuffer"),F=B("Function"),q=m.document&&m.document.childNodes,V=F="function"!=typeof/./&&"object"!=typeof Int8Array&&"function"!=typeof q?function(t){return"function"==typeof t||!1}:F,G=B("Object"),J=T&&G(new DataView(new ArrayBuffer(8))),Z="undefined"!=typeof Map&&G(new Map),Q=B("DataView");var X=J?function(t){return null!=t&&V(t.getInt8)&&R(t.buffer)}:Q,Y=k||B("Array");function tt(t,e){return null!=t&&x.call(t,e)}var et=B("Arguments");!function(){et(arguments)||(et=function(t){return tt(t,"callee")})}();var it=et;function rt(t){return z(t)&&S(t)}function nt(t){return function(){return t}}function ot(e){return function(t){t=e(t);return"number"==typeof t&&0<=t&&t<=U}}function st(e){return function(t){return null==t?void 0:t[e]}}var at=st("byteLength"),ht=ot(at),lt=/\[object ((I|Ui)nt(8|16|32)|Float(32|64)|Uint8Clamped|Big(I|Ui)nt64)Array\]/;var ct=L?function(t){return C?C(t)&&!X(t):ht(t)&&lt.test(w.call(t))}:nt(!1),ut=st("length");function ft(t,e){e=function(e){for(var i={},t=e.length,r=0;r<t;++r)i[e[r]]=!0;return{contains:function(t){return i[t]},push:function(t){return i[t]=!0,e.push(t)}}}(e);var i=M.length,r=t.constructor,n=V(r)&&r.prototype||g,o="constructor";for(tt(t,o)&&!e.contains(o)&&e.push(o);i--;)(o=M[i])in t&&t[o]!==n[o]&&!e.contains(o)&&e.push(o)}function dt(t){if(!j(t))return[];if(_)return _(t);var e,i=[];for(e in t)tt(t,e)&&i.push(e);return A&&ft(t,i),i}function mt(t,e){var i=dt(e),r=i.length;if(null==t)return!r;for(var n=Object(t),o=0;o<r;o++){var s=i[o];if(e[s]!==n[s]||!(s in n))return!1}return!0}function pt(t){return t instanceof pt?t:this instanceof pt?void(this._wrapped=t):new pt(t)}function gt(t){return new Uint8Array(t.buffer||t,t.byteOffset||0,at(t))}pt.VERSION=d,pt.prototype.valueOf=pt.prototype.toJSON=pt.prototype.value=function(){return this._wrapped},pt.prototype.toString=function(){return String(this._wrapped)};var bt="[object DataView]";function vt(t,e,i,r){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return!1;if(t!=t)return e!=e;var n=typeof t;return("function"==n||"object"==n||"object"==typeof e)&&function t(e,i,r,n){e instanceof pt&&(e=e._wrapped);i instanceof pt&&(i=i._wrapped);var o=w.call(e);if(o!==w.call(i))return!1;if(J&&"[object Object]"==o&&X(e)){if(!X(i))return!1;o=bt}switch(o){case"[object RegExp]":case"[object String]":return""+e==""+i;case"[object Number]":return+e!=+e?+i!=+i:0==+e?1/+e==1/i:+e==+i;case"[object Date]":case"[object Boolean]":return+e==+i;case"[object Symbol]":return b.valueOf.call(e)===b.valueOf.call(i);case"[object ArrayBuffer]":case bt:return t(gt(e),gt(i),r,n)}var s="[object Array]"===o;if(!s&&ct(e)){var a=at(e);if(a!==at(i))return!1;if(e.buffer===i.buffer&&e.byteOffset===i.byteOffset)return!0;s=!0}if(!s){if("object"!=typeof e||"object"!=typeof i)return!1;o=e.constructor,a=i.constructor;if(o!==a&&!(V(o)&&o instanceof o&&V(a)&&a instanceof a)&&"constructor"in e&&"constructor"in i)return!1}r=r||[];n=n||[];var h=r.length;for(;h--;)if(r[h]===e)return n[h]===i;r.push(e);n.push(i);if(s){if((h=e.length)!==i.length)return!1;for(;h--;)if(!vt(e[h],i[h],r,n))return!1}else{var l,c=dt(e);if(h=c.length,dt(i).length!==h)return!1;for(;h--;)if(l=c[h],!tt(i,l)||!vt(e[l],i[l],r,n))return!1}r.pop();n.pop();return!0}(t,e,i,r)}function yt(t){if(!j(t))return[];var e,i=[];for(e in t)i.push(e);return A&&ft(t,i),i}function wt(r){var n=ut(r);return function(t){if(null==t)return!1;var e=yt(t);if(ut(e))return!1;for(var i=0;i<n;i++)if(!V(t[r[i]]))return!1;return r!==_t||!V(t[xt])}}var xt="forEach",Lt=["clear","delete"],Tt=["get","has","set"],kt=Lt.concat(xt,Tt),_t=Lt.concat(Tt),Dt=["add"].concat(Lt,xt,"has"),Ct=Z?wt(kt):B("Map"),St=Z?wt(_t):B("WeakMap"),Ot=Z?wt(Dt):B("Set"),At=B("WeakSet");function Mt(t){for(var e=dt(t),i=e.length,r=Array(i),n=0;n<i;n++)r[n]=t[e[n]];return r}function Ut(t){for(var e={},i=dt(t),r=0,n=i.length;r<n;r++)e[t[i[r]]]=i[r];return e}function Et(t){var e,i=[];for(e in t)V(t[e])&&i.push(e);return i.sort()}function jt(h,l){return function(t){var e=arguments.length;if(l&&(t=Object(t)),e<2||null==t)return t;for(var i=1;i<e;i++)for(var r=arguments[i],n=h(r),o=n.length,s=0;s<o;s++){var a=n[s];l&&void 0!==t[a]||(t[a]=r[a])}return t}}var Nt=jt(yt),Wt=jt(dt),Bt=jt(yt,!0);function It(t){if(!j(t))return{};if(D)return D(t);var e=function(){};e.prototype=t;t=new e;return e.prototype=null,t}function zt(t){return j(t)?Y(t)?t.slice():Nt({},t):t}function Kt(t){return Y(t)?t:[t]}function Ht(t){return pt.toPath(t)}function Pt(t,e){for(var i=e.length,r=0;r<i;r++){if(null==t)return;t=t[e[r]]}return i?t:void 0}function $t(t,e,i){e=Pt(t,Ht(e));return N(e)?i:e}function Rt(t){return t}function Ft(e){return e=Wt({},e),function(t){return mt(t,e)}}function qt(e){return e=Ht(e),function(t){return Pt(t,e)}}function Vt(n,o,t){if(void 0===o)return n;switch(null==t?3:t){case 1:return function(t){return n.call(o,t)};case 3:return function(t,e,i){return n.call(o,t,e,i)};case 4:return function(t,e,i,r){return n.call(o,t,e,i,r)}}return function(){return n.apply(o,arguments)}}function Gt(t,e,i){return null==t?Rt:V(t)?Vt(t,e,i):(j(t)&&!Y(t)?Ft:qt)(t)}function Jt(t,e){return Gt(t,e,1/0)}function Zt(t,e,i){return pt.iteratee!==Jt?pt.iteratee(t,e):Gt(t,e,i)}function Qt(){}function Xt(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))}pt.toPath=Kt,pt.iteratee=Jt;var Yt=Date.now||function(){return(new Date).getTime()};function te(e){function i(t){return e[t]}var t="(?:"+dt(e).join("|")+")",r=RegExp(t),n=RegExp(t,"g");return function(t){return r.test(t=null==t?"":""+t)?t.replace(n,i):t}}var ee={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},ie=te(ee),re=te(Ut(ee)),ne=pt.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},oe=/(.)^/,se={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},ae=/\\|'|\r|\n|\u2028|\u2029/g;function he(t){return"\\"+se[t]}var le=/^\s*(\w|\$)+\s*$/;var ce=0;function ue(t,e,i,r,n){if(!(r instanceof e))return t.apply(i,n);i=It(t.prototype),n=t.apply(i,n);return j(n)?n:i}var fe=E(function(n,o){function s(){for(var t=0,e=o.length,i=Array(e),r=0;r<e;r++)i[r]=o[r]===a?arguments[t++]:o[r];for(;t<arguments.length;)i.push(arguments[t++]);return ue(n,s,this,this,i)}var a=fe.placeholder;return s});fe.placeholder=pt;var de=E(function(e,i,r){if(!V(e))throw new TypeError("Bind must be called on a function");var n=E(function(t){return ue(e,n,i,this,r.concat(t))});return n}),me=ot(ut);function pe(t,e,i,r){if(r=r||[],e||0===e){if(e<=0)return r.concat(t)}else e=1/0;for(var n=r.length,o=0,s=ut(t);o<s;o++){var a=t[o];if(me(a)&&(Y(a)||it(a)))if(1<e)pe(a,e-1,i,r),n=r.length;else for(var h=0,l=a.length;h<l;)r[n++]=a[h++];else i||(r[n++]=a)}return r}var ge=E(function(t,e){var i=(e=pe(e,!1,!1)).length;if(i<1)throw new Error("bindAll must be passed function names");for(;i--;){var r=e[i];t[r]=de(t[r],t)}return t});var be=E(function(t,e,i){return setTimeout(function(){return t.apply(null,i)},e)}),ve=fe(be,pt,1);function ye(t){return function(){return!t.apply(this,arguments)}}function we(t,e){var i;return function(){return 0<--t&&(i=e.apply(this,arguments)),t<=1&&(e=null),i}}m=fe(we,2);function xe(t,e,i){e=Zt(e,i);for(var r,n=dt(t),o=0,s=n.length;o<s;o++)if(e(t[r=n[o]],r,t))return r}function Le(o){return function(t,e,i){e=Zt(e,i);for(var r=ut(t),n=0<o?0:r-1;0<=n&&n<r;n+=o)if(e(t[n],n,t))return n;return-1}}var Te=Le(1),q=Le(-1);function ke(t,e,i,r){for(var n=(i=Zt(i,r,1))(e),o=0,s=ut(t);o<s;){var a=Math.floor((o+s)/2);i(t[a])<n?o=a+1:s=a}return o}function _e(o,s,a){return function(t,e,i){var r=0,n=ut(t);if("number"==typeof i)0<o?r=0<=i?i:Math.max(i+n,r):n=0<=i?Math.min(i+1,n):i+n+1;else if(a&&i&&n)return t[i=a(t,e)]===e?i:-1;if(e!=e)return 0<=(i=s(y.call(t,r,n),rt))?i+r:-1;for(i=0<o?r:n-1;0<=i&&i<n;i+=o)if(t[i]===e)return i;return-1}}var De=_e(1,Te,ke),F=_e(-1,q);function Ce(t,e,i){i=(me(t)?Te:xe)(t,e,i);if(void 0!==i&&-1!==i)return t[i]}function Se(t,e,i){if(e=Vt(e,i),me(t))for(n=0,o=t.length;n<o;n++)e(t[n],n,t);else for(var r=dt(t),n=0,o=r.length;n<o;n++)e(t[r[n]],r[n],t);return t}function Oe(t,e,i){e=Zt(e,i);for(var r=!me(t)&&dt(t),n=(r||t).length,o=Array(n),s=0;s<n;s++){var a=r?r[s]:s;o[s]=e(t[a],a,t)}return o}function Ae(h){return function(t,e,i,r){var n=3<=arguments.length;return function(t,e,i,r){var n=!me(t)&&dt(t),o=(n||t).length,s=0<h?0:o-1;for(r||(i=t[n?n[s]:s],s+=h);0<=s&&s<o;s+=h){var a=n?n[s]:s;i=e(i,t[a],a,t)}return i}(t,Vt(e,r,4),i,n)}}T=Ae(1),G=Ae(-1);function Me(t,r,e){var n=[];return r=Zt(r,e),Se(t,function(t,e,i){r(t,e,i)&&n.push(t)}),n}function Ue(t,e,i){e=Zt(e,i);for(var r=!me(t)&&dt(t),n=(r||t).length,o=0;o<n;o++){var s=r?r[o]:o;if(!e(t[s],s,t))return!1}return!0}function Ee(t,e,i){e=Zt(e,i);for(var r=!me(t)&&dt(t),n=(r||t).length,o=0;o<n;o++){var s=r?r[o]:o;if(e(t[s],s,t))return!0}return!1}function je(t,e,i,r){return me(t)||(t=Mt(t)),0<=De(t,e,i="number"!=typeof i||r?0:i)}Q=E(function(t,i,r){var n,o;return V(i)?o=i:(i=Ht(i),n=i.slice(0,-1),i=i[i.length-1]),Oe(t,function(t){var e=o;if(!e){if(null==(t=n&&n.length?Pt(t,n):t))return;e=t[i]}return null==e?e:e.apply(t,r)})});function Ne(t,e){return Oe(t,qt(e))}function We(t,r,e){var i,n,o=-1/0,s=-1/0;if(null==r||"number"==typeof r&&"object"!=typeof t[0]&&null!=t)for(var a=0,h=(t=me(t)?t:Mt(t)).length;a<h;a++)null!=(i=t[a])&&o<i&&(o=i);else r=Zt(r,e),Se(t,function(t,e,i){n=r(t,e,i),(s<n||n===-1/0&&o===-1/0)&&(o=t,s=n)});return o}function Be(t,e,i){if(null==e||i)return(t=!me(t)?Mt(t):t)[Xt(t.length-1)];var r=(me(t)?zt:Mt)(t),t=ut(r);e=Math.max(Math.min(e,t),0);for(var n=t-1,o=0;o<e;o++){var s=Xt(o,n),a=r[o];r[o]=r[s],r[s]=a}return r.slice(0,e)}function Ie(o,e){return function(i,r,t){var n=e?[[],[]]:{};return r=Zt(r,t),Se(i,function(t,e){e=r(t,e,i);o(n,t,e)}),n}}var k=Ie(function(t,e,i){tt(t,i)?t[i].push(e):t[i]=[e]}),L=Ie(function(t,e,i){t[i]=e}),Tt=Ie(function(t,e,i){tt(t,i)?t[i]++:t[i]=1}),Lt=Ie(function(t,e,i){t[i?0:1].push(e)},!0),ze=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;function Ke(t,e,i){return e in i}var He=E(function(t,e){var i={},r=e[0];if(null==t)return i;V(r)?(1<e.length&&(r=Vt(r,e[1])),e=yt(t)):(r=Ke,e=pe(e,!1,!1),t=Object(t));for(var n=0,o=e.length;n<o;n++){var s=e[n],a=t[s];r(a,s,t)&&(i[s]=a)}return i}),kt=E(function(t,i){var e,r=i[0];return V(r)?(r=ye(r),1<i.length&&(e=i[1])):(i=Oe(pe(i,!1,!1),String),r=function(t,e){return!je(i,e)}),He(t,r,e)});function Pe(t,e,i){return y.call(t,0,Math.max(0,t.length-(null==e||i?1:e)))}function $e(t,e,i){return null==t||t.length<1?null==e||i?void 0:[]:null==e||i?t[0]:Pe(t,t.length-e)}function Re(t,e,i){return y.call(t,null==e||i?1:e)}var Fe=E(function(t,e){return e=pe(e,!0,!0),Me(t,function(t){return!je(e,t)})}),Z=E(function(t,e){return Fe(t,e)});function qe(t,e,i,r){W(e)||(r=i,i=e,e=!1),null!=i&&(i=Zt(i,r));for(var n=[],o=[],s=0,a=ut(t);s<a;s++){var h=t[s],l=i?i(h,s,t):h;e&&!i?(s&&o===l||n.push(h),o=l):i?je(o,l)||(o.push(l),n.push(h)):je(n,h)||n.push(h)}return n}Dt=E(function(t){return qe(pe(t,!0,!0))});function Ve(t){for(var e=t&&We(t,ut).length||0,i=Array(e),r=0;r<e;r++)i[r]=Ne(t,r);return i}ee=E(Ve);function Ge(t,e){return t._chain?pt(e).chain():e}function Je(i){return Se(Et(i),function(t){var e=pt[t]=i[t];pt.prototype[t]=function(){var t=[this._wrapped];return v.apply(t,arguments),Ge(this,e.apply(pt,t))}}),pt}Se(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var i=p[e];pt.prototype[e]=function(){var t=this._wrapped;return null!=t&&(i.apply(t,arguments),"shift"!==e&&"splice"!==e||0!==t.length||delete t[0]),Ge(this,t)}}),Se(["concat","join","slice"],function(t){var e=p[t];pt.prototype[t]=function(){var t=this._wrapped;return Ge(this,t=null!=t?e.apply(t,arguments):t)}});var Ze=Je(Object.freeze({__proto__:null,VERSION:d,restArguments:E,isObject:j,isNull:function(t){return null===t},isUndefined:N,isBoolean:W,isElement:function(t){return!(!t||1!==t.nodeType)},isString:I,isNumber:z,isDate:K,isRegExp:H,isError:P,isSymbol:$,isArrayBuffer:R,isDataView:X,isArray:Y,isFunction:V,isArguments:it,isFinite:function(t){return!$(t)&&O(t)&&!isNaN(parseFloat(t))},isNaN:rt,isTypedArray:ct,isEmpty:function(t){if(null==t)return!0;var e=ut(t);return"number"==typeof e&&(Y(t)||I(t)||it(t))?0===e:0===ut(dt(t))},isMatch:mt,isEqual:function(t,e){return vt(t,e)},isMap:Ct,isWeakMap:St,isSet:Ot,isWeakSet:At,keys:dt,allKeys:yt,values:Mt,pairs:function(t){for(var e=dt(t),i=e.length,r=Array(i),n=0;n<i;n++)r[n]=[e[n],t[e[n]]];return r},invert:Ut,functions:Et,methods:Et,extend:Nt,extendOwn:Wt,assign:Wt,defaults:Bt,create:function(t,e){return t=It(t),e&&Wt(t,e),t},clone:zt,tap:function(t,e){return e(t),t},get:$t,has:function(t,e){for(var i=(e=Ht(e)).length,r=0;r<i;r++){var n=e[r];if(!tt(t,n))return!1;t=t[n]}return!!i},mapObject:function(t,e,i){e=Zt(e,i);for(var r=dt(t),n=r.length,o={},s=0;s<n;s++){var a=r[s];o[a]=e(t[a],a,t)}return o},identity:Rt,constant:nt,noop:Qt,toPath:Kt,property:qt,propertyOf:function(e){return null==e?Qt:function(t){return $t(e,t)}},matcher:Ft,matches:Ft,times:function(t,e,i){var r=Array(Math.max(0,t));e=Vt(e,i,1);for(var n=0;n<t;n++)r[n]=e(n);return r},random:Xt,now:Yt,escape:ie,unescape:re,templateSettings:ne,template:function(o,t,e){t=Bt({},t=!t&&e?e:t,pt.templateSettings);var i,e=RegExp([(t.escape||oe).source,(t.interpolate||oe).source,(t.evaluate||oe).source].join("|")+"|$","g"),s=0,a="__p+='";if(o.replace(e,function(t,e,i,r,n){return a+=o.slice(s,n).replace(ae,he),s=n+t.length,e?a+="'+\n((__t=("+e+"))==null?'':_.escape(__t))+\n'":i?a+="'+\n((__t=("+i+"))==null?'':__t)+\n'":r&&(a+="';\n"+r+"\n__p+='"),t}),a+="';\n",e=t.variable){if(!le.test(e))throw new Error("variable is not a bare identifier: "+e)}else a="with(obj||{}){\n"+a+"}\n",e="obj";a="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{i=new Function(e,"_",a)}catch(t){throw t.source=a,t}return(t=function(t){return i.call(this,t,pt)}).source="function("+e+"){\n"+a+"}",t},result:function(t,e,i){var r=(e=Ht(e)).length;if(!r)return V(i)?i.call(t):i;for(var n=0;n<r;n++){var o=null==t?void 0:t[e[n]];void 0===o&&(o=i,n=r),t=V(o)?o.call(t):o}return t},uniqueId:function(t){var e=++ce+"";return t?t+e:e},chain:function(t){return(t=pt(t))._chain=!0,t},iteratee:Jt,partial:fe,bind:de,bindAll:ge,memoize:function(i,r){function n(t){var e=n.cache,t=""+(r?r.apply(this,arguments):t);return tt(e,t)||(e[t]=i.apply(this,arguments)),e[t]}return n.cache={},n},delay:be,defer:ve,throttle:function(i,r,n){var o,s,a,h,l=0;function c(){l=!1===n.leading?0:Yt(),o=null,h=i.apply(s,a),o||(s=a=null)}function t(){var t=Yt();l||!1!==n.leading||(l=t);var e=r-(t-l);return s=this,a=arguments,e<=0||r<e?(o&&(clearTimeout(o),o=null),l=t,h=i.apply(s,a),o||(s=a=null)):o||!1===n.trailing||(o=setTimeout(c,e)),h}return n=n||{},t.cancel=function(){clearTimeout(o),l=0,o=s=a=null},t},debounce:function(e,i,r){function n(){var t=Yt()-s;t<i?o=setTimeout(n,i-t):(o=null,r||(h=e.apply(l,a)),o||(a=l=null))}var o,s,a,h,l,t=E(function(t){return l=this,a=t,s=Yt(),o||(o=setTimeout(n,i),r&&(h=e.apply(l,a))),h});return t.cancel=function(){clearTimeout(o),o=a=l=null},t},wrap:function(t,e){return fe(e,t)},negate:ye,compose:function(){var i=arguments,r=i.length-1;return function(){for(var t=r,e=i[r].apply(this,arguments);t--;)e=i[t].call(this,e);return e}},after:function(t,e){return function(){if(--t<1)return e.apply(this,arguments)}},before:we,once:m,findKey:xe,findIndex:Te,findLastIndex:q,sortedIndex:ke,indexOf:De,lastIndexOf:F,find:Ce,detect:Ce,findWhere:function(t,e){return Ce(t,Ft(e))},each:Se,forEach:Se,map:Oe,collect:Oe,reduce:T,foldl:T,inject:T,reduceRight:G,foldr:G,filter:Me,select:Me,reject:function(t,e,i){return Me(t,ye(Zt(e)),i)},every:Ue,all:Ue,some:Ee,any:Ee,contains:je,includes:je,include:je,invoke:Q,pluck:Ne,where:function(t,e){return Me(t,Ft(e))},max:We,min:function(t,r,e){var i,n,o=1/0,s=1/0;if(null==r||"number"==typeof r&&"object"!=typeof t[0]&&null!=t)for(var a=0,h=(t=me(t)?t:Mt(t)).length;a<h;a++)null!=(i=t[a])&&i<o&&(o=i);else r=Zt(r,e),Se(t,function(t,e,i){((n=r(t,e,i))<s||n===1/0&&o===1/0)&&(o=t,s=n)});return o},shuffle:function(t){return Be(t,1/0)},sample:Be,sortBy:function(t,r,e){var n=0;return r=Zt(r,e),Ne(Oe(t,function(t,e,i){return{value:t,index:n++,criteria:r(t,e,i)}}).sort(function(t,e){var i=t.criteria,r=e.criteria;if(i!==r){if(r<i||void 0===i)return 1;if(i<r||void 0===r)return-1}return t.index-e.index}),"value")},groupBy:k,indexBy:L,countBy:Tt,partition:Lt,toArray:function(t){return t?Y(t)?y.call(t):I(t)?t.match(ze):me(t)?Oe(t,Rt):Mt(t):[]},size:function(t){return null==t?0:(me(t)?t:dt(t)).length},pick:He,omit:kt,first:$e,head:$e,take:$e,initial:Pe,last:function(t,e,i){return null==t||t.length<1?null==e||i?void 0:[]:null==e||i?t[t.length-1]:Re(t,Math.max(0,t.length-e))},rest:Re,tail:Re,drop:Re,compact:function(t){return Me(t,Boolean)},flatten:function(t,e){return pe(t,e,!1)},without:Z,uniq:qe,unique:qe,union:Dt,intersection:function(t){for(var e=[],i=arguments.length,r=0,n=ut(t);r<n;r++){var o=t[r];if(!je(e,o)){for(var s=1;s<i&&je(arguments[s],o);s++);s===i&&e.push(o)}}return e},difference:Fe,unzip:Ve,transpose:Ve,zip:ee,object:function(t,e){for(var i={},r=0,n=ut(t);r<n;r++)e?i[t[r]]=e[r]:i[t[r][0]]=t[r][1];return i},range:function(t,e,i){null==e&&(e=t||0,t=0),i=i||(e<t?-1:1);for(var r=Math.max(Math.ceil((e-t)/i),0),n=Array(r),o=0;o<r;o++,t+=i)n[o]=t;return n},chunk:function(t,e){if(null==e||e<1)return[];for(var i=[],r=0,n=t.length;r<n;)i.push(y.call(t,r,r+=e));return i},mixin:Je,default:pt}));Ze._=Ze;const Qe=(t,e)=>{let i=document.getElementsByTagName("iframe")[0];var r;"scroll"===e?(r=i.contentWindow.document.body,e=i.contentWindow.document.documentElement,i.height=2*Math.max(r.scrollHeight,r.offsetHeight,e.clientHeight,e.scrollHeight,e.offsetHeight),setTimeout(()=>{let t=document.getElementsByTagName("iframe")[0],e=t.contentWindow.document.body;var i=e.lastElementChild,r=e.lastChild,n=e.getElementsByTagName("a"),o=e.getElementsByTagName("p"),s=e.getElementsByTagName("img"),a=n[n.length-1],n=o[o.length-1],s=o[s.length-1];let h=n||a||s;Ze.isElement(a)&&Ze.isElement(n)&&(h=a.clientHeight+a.offsetTop>n.clientHeight+n.offsetTop?a:n),Ze.isElement(s)&&s.clientHeight+s.offsetTop>h.clientHeight+h.offsetTop&&(h=s);let l=0;if((i||h||r)&&(3!==r.nodeType||i||h)){if(3===r.nodeType&&document.createRange){let t=document.createRange();t.selectNodeContents(r),!t.getBoundingClientRect||(s=t.getBoundingClientRect())&&(l=s.bottom-s.top)}t.height=Math.max(Ze.isElement(i)?i.clientHeight+i.offsetTop:0,Ze.isElement(r)?r.clientHeight+r.offsetTop:0,Ze.isElement(h)?h.clientHeight+h.offsetTop:0)+400+(3===r.nodeType?l:0)}},500)):i.height=t.offsetHeight},Xe=t=>{var e=document.createElement("iframe");e.style.width="100%",e.style.border="0",e.style.margin="0",e.style.padding="0",e.style.fontSize="100%",e.style.font="inherit",e.style.verticalAlign="baseline",t.innerHTML="",t.appendChild(e)},Ye=(t,e)=>{"scroll"!==e&&window.frames[0].document.body.setAttribute("style",`width: auto;
    height: 100%;
    overflow-y: hidden;
    overflow-X: hidden;
    padding-left: 0px;
    padding-right: 0px;
    margin: 0px !important;
    box-sizing: border-box;
    max-width: inherit;
    column-fill: auto;
    column-gap: 88px;
    column-count: 12;
    column-width: ${(t.offsetWidth-88)/("double"===e?2:1)}px;`)};let ti=!1;const ei=(t,e,i,r,n)=>{0<n&&0<window.frames[0].document.body.scrollLeft?window.frames[0].document.body.scrollLeft-=t.offsetWidth+88:0<n&&0===window.frames[0].document.body.scrollLeft?ii(t,e,i,r):n<0&&(((t,e,i,r)=>{if(Math.abs(t.scrollHeight-t.scrollTop-t.clientHeight)<10&&Math.abs(window.frames[0].document.body.scrollWidth-window.frames[0].document.body.scrollLeft-window.frames[0].document.body.clientWidth)<10)si(t,e,i,r)})(t,e,i,r),window.frames[0].document.body.scrollLeft+=t.offsetWidth+88)},ii=(t,e,i,r)=>{var n=s.getKookitConfig("chapterTitle"),o=Ze.findIndex(e,{label:n});0!==o&&-1!==o&&n&&(s.setKookitConfig("chapterTitle",e[o-1].label),s.setKookitConfig("text","prevChapter"),ri(e[o-1].label,i,t,r))},ri=(t="",e,i,r)=>{window.frames[0].document.body.innerHTML="";let n=Ze.findIndex(e,{title:t});n=-1===n?0:n,window.frames[0].document.body.innerHTML=e[n].text,s.setKookitConfig("chapterTitle",e[n].title),Qe(i,r),(()=>{var r,t=document.getElementsByTagName("iframe")[0];if(t){let i=t.contentDocument;if(i){let t,e;for(r of i.getElementsByTagName("img")){var n=r.parentElement;r.width&&r.height?r.height/r.width>n.clientHeight/n.clientWidth?(t=n.clientHeight,e=t*r.width/r.height):(e=n.clientWidth,t=e*r.height/r.width):e=n.clientWidth,r.setAttribute("style",`max-width: ${e}px;max-height:${t}px`)}}}})(),ni(i,r)},ni=(e,i,r="",n="0")=>{let o=r||s.getKookitConfig("text")||"";if(o){let t=Array.from(window.frames[0].document.body.querySelectorAll("h1,h2,h3,h4,p"));r=t.filter((t,e)=>t.innerText===o&&e===parseInt(s.getKookitConfig("count")||n))[0];"scroll"!==i?window.frames[0].document.body.scrollTo(o&&r?r.offsetLeft:"prevChapter"===o?window.frames[0].document.body.scrollWidth:0,0):e.scrollTo(0,o&&r?r.offsetTop:0)}else("scroll"!==i?window.frames[0].document.body:e).scrollTo(0,0)},oi=(i,r)=>{if(!ti){var t=Array.from(window.frames[0].document.body.querySelectorAll("h1,h2,h3,h4,p,img")).filter(t=>ai(i,t,r)&&t.innerText.trim()),n=t["scroll"===r?Math.floor(t.length/2):0];let e=0;var o=Array.from(window.frames[0].document.body.querySelectorAll("h1,h2,h3,h4,p,img"));for(let t=0;t<o.length;t++){if(ai(i,o[t],r)){e=t;break}if(ai(i,o[t],r)&&n&&o[t].innerHTML===n.innerHTML&&"IMG"!==o[t].tagName){e=t;break}}s.setKookitConfig("text",n?n.innerText:""),s.setKookitConfig("count",e+""),ti=!0,setTimeout(()=>{ti=!1},100)}},si=(t,e,i,r)=>{var n=s.getKookitConfig("chapterTitle"),n=Ze.findIndex(e,{label:n});n!==e.length-1&&-1!==n&&(s.setKookitConfig("chapterTitle",e[n+1].label),s.setKookitConfig("text",""),ri(e[n+1].label,i,t,r))},ai=(t,e,i)=>{var r=!1,n=e.getBoundingClientRect();return"scroll"!==i&&(e.innerText.trim()||e.id&&"IMG"===e.tagName)?r=0<=(i=n.left)&&i<=t.offsetWidth:(e.innerText.trim()||e.id&&"IMG"===e.tagName)&&(r=(n=n.top)>=t.scrollTop&&n<=t.scrollTop+t.offsetHeight),r};class hi{constructor(t){this.bookStr=t,this.chapterList=[],this.chapterDocList=[]}getChapterDoc(){var e=-1<this.bookStr.indexOf("<mbp:pagebreak>")?this.bookStr.split("<mbp:pagebreak>"):this.bookStr.split("<address> </address>");let n=[],o=[],i="";for(let t=0;t<e.length;t++)(t=>{var e=0<t.querySelectorAll("h1,h2,h3,h4,blockquote,font,b").length;let i=t.querySelectorAll("h1,h2,h3,h4,blockquote,font,b"),r=t.getElementsByTagName("p"),n;for(let t=0;t<i.length;t++){var o=n&&("♦"===i[t].innerText.trim()||"●"===i[t].innerText.trim()||"◾"===i[t].innerText.trim()||"◀"===i[t].innerText.trim()||"◼"===i[t].innerText.trim()||"■"===i[t].innerText.trim());if(i[t].innerText.trim()&&!o){n=i[t];break}}for(let t=0;t<r.length&&(!r[t].innerText.trim()||-1!==r[t].innerHTML.indexOf("<"));t++);var s=n&&30<n.innerText.trim().length,t=50<t.body.innerText.length;return e&&(!s||a(n.innerText.trim()))&&t})((new DOMParser).parseFromString(e[t],"text/html"))?(n.push(i+e[t]),i=""):i+=e[t];0===n.length&&n.push(i);for(let r=0;r<n.length;r++){let t=(new DOMParser).parseFromString(n[r],"text/html"),e=t.querySelectorAll("h1,h2,h3,h4,blockquote,font,b"),i;for(let t=0;t<e.length;t++){var s="♦"===e[t].innerText.trim()||"●"===e[t].innerText.trim()||"◾"===e[t].innerText.trim()||"◀"===e[t].innerText.trim()||"◼"===e[t].innerText.trim()||"■"===e[t].innerText.trim();if(e[t].innerText.trim()&&!s){i=e[t];break}}this.chapterDocList.push({title:i?-1===o.indexOf(i.innerText)?i.innerText:i.innerText+"#"+r:"Forword",text:n[r]}),i&&o.push(i.innerText)}return this.chapterDocList}getChapter(){for(let t=0;t<this.chapterDocList.length;t++){var e=Math.floor(9e5*Math.random())+1e5;this.chapterList.push({label:this.chapterDocList[t].title,id:"title"+e,href:"#title"+e,subitems:[]})}return this.chapterList}}class li{constructor(t){this.bookStr=t,this.chapterList=[],this.chapterDocList=[],this.bookDoc=(new DOMParser).parseFromString(this.bookStr,"text/html"),this.chapterDomList=[]}getChapter(){if(this.chapterDomList=Array.from(this.bookDoc.querySelectorAll("h1,h2,h3,h4,font,b")),0<this.chapterDomList.length){this.insertPageBreak();let t=new hi(this.bookDoc.body.innerHTML);this.chapterDocList=t.getChapterDoc(),this.chapterList=t.getChapter()}else this.getExtraTitle(),this.generateChapterList(),this.insertPageBreak();return this.chapterList}insertPageBreak(){for(let t=0;t<this.chapterDomList.length;t++){var e=document.createElement("address"),i=document.createTextNode(" ");e.appendChild(i),this.chapterDomList[t].parentNode&&this.chapterDomList[t].parentNode.insertBefore(e,this.chapterDomList[t])}}generateChapterList(){var t;0===this.chapterDomList.length&&(t=Math.floor(9e5*Math.random())+1e5,this.chapterList.push({label:"Forword",id:"title"+t,href:"#title"+t,subitems:[]}));let e=[];for(let t=0;t<this.chapterDomList.length;t++){var i=Math.floor(9e5*Math.random())+1e5;this.chapterList.push({label:this.chapterDomList[t]?-1===e.lastIndexOf(this.chapterDomList[t].innerText)?this.chapterDomList[t].innerText:e[e.lastIndexOf(this.chapterDomList[t].innerText)]+"#"+t:"Forword",id:"title"+i,href:"#title"+i,subitems:[]}),e.push(this.chapterList[t].label)}}getExtraTitle(){let e=!1;0===this.chapterDomList.length&&(this.chapterDomList=Array.from(this.bookDoc.getElementsByTagName("p")).filter(t=>(!e&&(t.innerText.trim().startsWith("第")&&i(t.innerText.trim())||t.innerText.trim().startsWith("Chapter")||t.innerText.trim().startsWith("CHAPTER"))&&(e=!0),a(t.innerText.trim(),e))))}getChapterDoc(){if(0<this.chapterDocList.length)return this.chapterDocList;var e,i=this.bookDoc.body.innerHTML.split("<address> </address>");for(let t=0;t<i.length;t++)i.length>this.chapterList.length&&0===t&&(e=Math.floor(9e5*Math.random())+1e5,this.chapterList.unshift({label:"Forword#"+t,id:"title"+e,href:"#title"+e,subitems:[]})),this.chapterDocList.push({title:this.chapterList[t].label,text:i[t]});return this.chapterDocList}}class ci{constructor(){this.callbacks={},this.callbacks.base={}}on(t,e){const i=this;if(void 0===t||""===t)return console.warn("wrong names"),!1;if(void 0===e)return console.warn("wrong callback"),!1;const r=this.resolveNames(t);return r.forEach(function(t){t=i.resolveName(t);i.callbacks[t.namespace]instanceof Object||(i.callbacks[t.namespace]={}),i.callbacks[t.namespace][t.value]instanceof Array||(i.callbacks[t.namespace][t.value]=[]),i.callbacks[t.namespace][t.value].push(e)}),this}off(t){const r=this;if(void 0===t||""===t)return console.warn("wrong name"),!1;const e=this.resolveNames(t);return e.forEach(function(t){var e=r.resolveName(t);if("base"!==e.namespace&&""===e.value)delete r.callbacks[e.namespace];else if("base"===e.namespace)for(const i in r.callbacks)r.callbacks[i]instanceof Object&&r.callbacks[i][e.value]instanceof Array&&(delete r.callbacks[i][e.value],0===Object.keys(r.callbacks[i]).length&&delete r.callbacks[i]);else r.callbacks[e.namespace]instanceof Object&&r.callbacks[e.namespace][e.value]instanceof Array&&(delete r.callbacks[e.namespace][e.value],0===Object.keys(r.callbacks[e.namespace]).length&&delete r.callbacks[e.namespace])}),this}trigger(t,e=[]){if(void 0===t||""===t)return console.warn("wrong name"),!1;const i=this;const r=e instanceof Array?e:[];let n=this.resolveNames(t);n=this.resolveName(n[0]),setTimeout(()=>{if("base"===n.namespace)for(const t in i.callbacks){if(i.callbacks[t]instanceof Object&&i.callbacks[t][n.value]instanceof Array)i.callbacks[t][n.value].forEach(function(t){t.apply(i,r)});else if(this.callbacks[n.namespace]instanceof Object){if(""===n.value)return console.warn("wrong name"),this;i.callbacks[n.namespace][n.value].forEach(function(t){t.apply(i,r)})}return null}},100)}resolveNames(t){let e=t;return e=e.replace(/[^a-zA-Z0-9 ,/.]/g,""),e=e.replace(/[,/]+/g," "),e=e.split(" "),e}resolveName(t){const e={};var i=t.split(".");return e.original=t,e.value=i[0],e.namespace="base",1<i.length&&""!==i[1]&&(e.namespace=i[1]),e}}function ui(t){return t instanceof ArrayBuffer&&(t=new Uint8Array(t)),new TextDecoder("utf-8").decode(t)}var fi=new DOMParser;class di{constructor(t){this.capacity=t,this.fragment_list=[],this.imageArray=[],this.cur_fragment=new mi(t),this.fragment_list.push(this.cur_fragment)}write(t){this.cur_fragment.write(t)||(this.cur_fragment=new mi(this.capacity),this.fragment_list.push(this.cur_fragment),this.cur_fragment.write(t))}get(t){for(var e=0;e<this.fragment_list.length;){var i=this.fragment_list[e];if(t<i.size)return i.get(t);t-=i.size,e+=1}return null}size(){for(var t=0,e=0;e<this.fragment_list.length;e++)t+=this.fragment_list[e].size;return t}shrink(){for(var t=new Uint8Array(this.size()),e=0,i=0;i<this.fragment_list.length;i++){var r=this.fragment_list[i];r.full()?t.set(r.buffer,e):t.set(r.buffer.slice(0,r.size),e),e+=r.size}return t}}class mi{constructor(t){this.buffer=new Uint8Array(t),this.capacity=t,this.size=0}write(t){return!(this.size>=this.capacity)&&(this.buffer[this.size]=t,this.size+=1,!0)}full(){return this.size===this.capacity}get(t){return this.buffer[t]}}class pi{constructor(t){this.render_image=(o,s)=>new Promise((i,e)=>{var r=o[s],t=+r.getAttribute("recindex"),n=this.read_image(t-1),t=new FileReader;t.onload=t=>{var e;r.src=null===(e=t.target)||void 0===e?void 0:e.result,i(null===(t=t.target)||void 0===t?void 0:t.result)},t.onerror=function(t){e(t)},t.readAsDataURL(n)}),this.view=new DataView(t),this.buffer=this.view.buffer,this.offset=0,this.header=null}parse(){}getUint8(){var t=this.view.getUint8(this.offset);return this.offset+=1,t}getUint16(){var t=this.view.getUint16(this.offset);return this.offset+=2,t}getUint32(){var t=this.view.getUint32(this.offset);return this.offset+=4,t}getStr(t){var e=ui(this.buffer.slice(this.offset,this.offset+t));return this.offset+=t,e}skip(t){this.offset+=t}setoffset(t){this.offset=t}get_record_extrasize(t,e){for(var i,r,n,o=t.length-1,s=0,a=15;0<a;a--)e&1<<a&&(r=(i=this.buffer_get_varlen(t,o))[0],n=i[1],o=i[2],o-=r-n,s+=r);return 1&e&&(s+=1+(3&t[o])),s}buffer_get_varlen(t,e){for(var i=0,r=0,n=0,o=0;;0){var s=t[e];if(r|=(127&s)<<o,o+=7,i+=1,--e,4<=(n+=1)||0<(128&s))break}return[r,i,e]}read_text(){for(var t=this.palm_header.record_count,e=[],i=1;i<=t;i++)e.push(this.read_text_record(i));return ui(function(e){var i=0;for(let t=0;t<e.length;t++){var r=e[t];i+=r.length}var n=new Uint8Array(i),o=0;for(let t=0;t<e.length;t++)r=e[t],n.set(r,o),o+=r.length;return n}(e))}read_text_record(t){var e=this.mobi_header.extra_flags,i=this.reclist[t].offset,r=this.reclist[t+1].offset,t=new Uint8Array(this.buffer.slice(i,r)),e=this.get_record_extrasize(t,e),t=new Uint8Array(this.buffer.slice(i,r-e));return 2!==this.palm_header.compression?t:function(t){for(var e=t.length,i=0,r=new di(t.length);i<e;){var n=t[i];if(i+=1,0===n)r.write(n);else if(n<=8){for(var o=i;o<i+n;o++)r.write(t[o]);i+=n}else if(n<=127)r.write(n);else if(n<=191){var s=t[i];i+=1;var a=(n<<8|s)>>3&2047,h=3+(7&s),l=r.size();for(let t=0;t<h;t++)r.write(r.get(l-a)),l+=1}else r.write(32),r.write(128^n)}return r}(t).shrink()}read_image(t){var e=this.mobi_header.first_image_idx,i=this.reclist[e+t].offset,t=this.reclist[e+t+1].offset,t=new Uint8Array(this.buffer.slice(i,t));return new Blob([t.buffer])}load(){this.header=this.load_pdbheader(),this.reclist=this.load_reclist(),this.load_record0()}load_pdbheader(){var t={};return t.name=this.getStr(32),t.attr=this.getUint16(),t.version=this.getUint16(),t.ctime=this.getUint32(),t.mtime=this.getUint32(),t.btime=this.getUint32(),t.mod_num=this.getUint32(),t.appinfo_offset=this.getUint32(),t.sortinfo_offset=this.getUint32(),t.type=this.getStr(4),t.creator=this.getStr(4),t.uid=this.getUint32(),t.next_rec=this.getUint32(),t.record_num=this.getUint16(),t}load_reclist(){for(var t=[],e=0;e<this.header.record_num;e++){var i={};i.offset=this.getUint32(),i.attr=this.getUint32(),t.push(i)}return t}load_record0(){this.palm_header=this.load_record0_header(),this.mobi_header=this.load_mobi_header()}load_record0_header(){var t={},e=this.reclist[0];return this.setoffset(e.offset),t.compression=this.getUint16(),this.skip(2),t.text_length=this.getUint32(),t.record_count=this.getUint16(),t.record_size=this.getUint16(),t.encryption_type=this.getUint16(),this.skip(2),t}load_mobi_header(){var t={},e=this.offset;return t.identifier=this.getUint32(),t.header_length=this.getUint32(),t.mobi_type=this.getUint32(),t.text_encoding=this.getUint32(),t.uid=this.getUint32(),t.generator_version=this.getUint32(),this.skip(40),t.first_nonbook_index=this.getUint32(),t.full_name_offset=this.getUint32(),t.full_name_length=this.getUint32(),t.language=this.getUint32(),t.input_language=this.getUint32(),t.output_language=this.getUint32(),t.min_version=this.getUint32(),t.first_image_idx=this.getUint32(),t.huff_rec_index=this.getUint32(),t.huff_rec_count=this.getUint32(),t.datp_rec_index=this.getUint32(),t.datp_rec_count=this.getUint32(),t.exth_flags=this.getUint32(),this.skip(36),t.drm_offset=this.getUint32(),t.drm_count=this.getUint32(),t.drm_size=this.getUint32(),t.drm_flags=this.getUint32(),this.skip(8),this.skip(4),this.skip(46),t.extra_flags=this.getUint16(),this.setoffset(e+t.header_length),t}load_exth_header(){return{}}extractContent(t){var e=document.createElement("span");return e.innerHTML=t,e.textContent||e.innerText}render(){return new Promise((i,t)=>n(this,void 0,void 0,function*(){this.load();var t=this.read_text(),t=fi.parseFromString(t,"text/html").documentElement,e=t.getElementsByTagName("img");for(let t=0;t<e.length;t++)yield this.render_image(e,t);i(t)}))}}class gi{constructor(t){this.bookStr=t,this.chapterList=[],this.chapterDocList=[],this.bookDoc=(new DOMParser).parseFromString(this.bookStr,"text/html"),this.chapterDomList=[]}getChapter(){let e=[];this.chapterDomList=Array.from(this.bookDoc.getElementsByTagName("h1"));for(let t=0;t<this.chapterDomList.length;t++){var i=Math.floor(9e5*Math.random())+1e5;this.chapterList.push({label:this.chapterDomList[t]?-1===e.lastIndexOf(this.chapterDomList[t].innerText)?this.chapterDomList[t].innerText:e[e.lastIndexOf(this.chapterDomList[t].innerText)]+"#"+t:"Forword",id:"title"+i,href:"#title"+i,subitems:[]}),e.push(this.chapterList[t].label)}for(let t=0;t<this.chapterDomList.length;t++){this.chapterDomList[t].id=this.chapterList[t].id;var r=document.createElement("span"),n=document.createTextNode("pagebreak");r.appendChild(n),this.chapterDomList[t].parentNode.insertBefore(r,this.chapterDomList[t])}return this.chapterList}getChapterDoc(){var e,i=this.bookDoc.body.innerHTML.split("<span>pagebreak</span>").filter(t=>t.trim());for(let t=0;t<i.length;t++)i.length>this.chapterList.length&&0===t&&(e=Math.floor(9e5*Math.random())+1e5,this.chapterList.unshift({label:"Forword#"+t,id:"title"+e,href:"#title"+e,subitems:[]})),this.chapterDocList.push({title:this.chapterList[t].label,text:i[t]});return this.chapterDocList}}const bi={svg:"image/svg+xml",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",zip:"application/zip",rar:"application/x-rar-compressed","7z":"application/x-7z-compressed",tar:"application/x-tar",html:"text/html",htm:"text/html",xml:"text/xml",xhtml:"application/xhtml+xml"};class vi{constructor(t,e,i,r,n){this.fileNameList=t,this.zip=e,this.bookStr="",this.format=n,this.bookDoc=null,this.mode=i,this.chapterList=[],this.extension=this.fileNameList[0].split(".").reverse()[0],this.element=r,this.getBookStr()}getBookStr(){let i=document.createElement("div");var r="single"===this.mode?1:2;for(let e=0;e<this.fileNameList.length;e++){let t=document.createElement("img");t.id=e+"",t.setAttribute("style",`width: ${"scroll"===this.mode?this.element.clientWidth:(this.element.clientWidth-88)/r}px;max-height:${"scroll"===this.mode?"inherit":this.element.clientHeight}px`),i.appendChild(t)}this.bookDoc=i}getChapter(){for(let t=0;t<this.fileNameList.length;t++)this.chapterList.push({label:this.fileNameList[t],id:t+"",href:"#"+t,subitems:[]});return this.chapterList}getImgRatio(){return this.extension=this.fileNameList[0].split(".").reverse()[0],new Promise((i,t)=>n(this,void 0,void 0,function*(){var t=new Image;t.onload=function(){i(t.height/t.width)};let e;e="cbr"===this.format?this.zip.decompress(this.fileNameList[0]):"cbt"===this.format?this.zip[Ze.findLastIndex(this.zip,{name:this.fileNameList[0]})].buffer:yield this.zip.file(this.fileNameList[0]).async("arraybuffer"),t.src="data:"+bi[this.extension.toLowerCase()]+";base64,"+this.base64ArrayBuffer(e)}))}renderComic(){window.frames[0].document.body.innerHTML=this.bookDoc.outerHTML}renderImage(e){return n(this,void 0,void 0,function*(){if(this.extension=this.fileNameList[0].split(".").reverse()[0],!window.frames[0].document.getElementById(e+"").src){let t;t="cbr"===this.format?this.zip.decompress(this.fileNameList[e]):"cbt"===this.format?this.zip[Ze.findLastIndex(this.zip,{name:this.fileNameList[e]})].buffer:yield this.zip.file(this.fileNameList[e]).async("arraybuffer"),window.frames[0].document.getElementById(e+"")&&(window.frames[0].document.getElementById(e+"").src="data:"+bi[this.extension.toLowerCase()]+";base64,"+this.base64ArrayBuffer(t))}})}base64ArrayBuffer(t){for(var e,i="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=new Uint8Array(t),o=n.byteLength,t=o%3,s=o-t,a=0;a<s;a+=3)i+=r[(16515072&(e=n[a]<<16|n[a+1]<<8|n[a+2]))>>18]+r[(258048&e)>>12]+r[(4032&e)>>6]+r[63&e];return 1==t?i+=r[(252&(e=n[s]))>>2]+r[(3&e)<<4]+"==":2==t&&(i+=r[(64512&(e=n[s]<<8|n[1+s]))>>10]+r[(1008&e)>>4]+r[(15&e)<<2]+"="),i}}const yi=(t,e)=>{0<e&&0<window.frames[0].document.body.scrollLeft?window.frames[0].document.body.scrollLeft-=t.offsetWidth+88:0<e&&0===window.frames[0].document.body.scrollLeft||e<0&&(window.frames[0].document.body.scrollLeft+=t.offsetWidth+88)},wi=(t,e,i="")=>{var r=i||parseInt(s.getKookitConfig("count"))||0;r?(i=Array.from(window.frames[0].document.body.querySelectorAll("img"))[r],"scroll"!==e?window.frames[0].document.body.scrollTo(r&&i?i.offsetLeft:0,0):t.scrollTo(0,r&&i?i.offsetTop:0)):("scroll"!==e?window.frames[0].document.body:t).scrollTo(0,0)};window.e=window.eval,window.a=window.atob,t.Azw3Render=class extends ci{constructor(t,e){super(),this.azw3Buffer=t,this.mode=e,this.chapterList=[],this.chapterDocList=[],this.bookStr="",this.element=""}renderTo(r){return n(this,void 0,void 0,function*(){return new Promise((i,t)=>n(this,void 0,void 0,function*(){if(yield f()){var e=(yield new pi(this.azw3Buffer).render()).outerHTML;this.bookStr=e,this.element=r;let t=new li(this.bookStr);this.chapterList=t.getChapter(),this.chapterDocList=t.getChapterDoc();e=s.getKookitConfig("chapterTitle")||this.chapterDocList[0].title;Xe(r),Ye(r,this.mode),ri(e,this.chapterDocList,this.element,this.mode),this.trigger("rendered"),i()}else i()}))})}getChapter(){return this.chapterList}goToChapter(t){ri(t,this.chapterDocList,this.element,this.mode)}goToPosition(t,e,i){ri(e,this.chapterDocList,this.element,this.mode),ni(this.element,this.mode,t,i)}prev(){"scroll"===this.mode||0===window.frames[0].document.body.scrollLeft?ii(this.element,this.chapterList,this.chapterDocList,this.mode):ei(this.element,this.chapterList,this.chapterDocList,this.mode,1),oi(this.element,this.mode)}next(){Math.abs(window.frames[0].document.body.scrollWidth-window.frames[0].document.body.scrollLeft-window.frames[0].document.body.clientWidth)<10||"scroll"===this.mode?si(this.element,this.chapterList,this.chapterDocList,this.mode):ei(this.element,this.chapterList,this.chapterDocList,this.mode,-1),oi(this.element,this.mode)}record(){oi(this.element,this.mode)}getPosition(){return{text:s.getKookitConfig("text"),chapterTitle:s.getKookitConfig("chapterTitle"),count:s.getKookitConfig("count")}}setStyle(t){window.frames[0].document.body.setAttribute("style",t+window.frames[0].document.body.getAttribute("style"))}},t.ComicRender=class extends ci{constructor(t,e,i,r){super(),this.mode=i,this.format=r,this.zip=e,this.dataSource=t,this.element="",this.parser="",this.chapterList=[],this.largestId=parseInt(s.getKookitConfig("count"))||0}renderTo(o,s=0){return new Promise((t,e)=>n(this,void 0,void 0,function*(){if(yield f()){this.element=o,Xe(o),this.parser=new vi(this.dataSource,this.zip,this.mode,this.element,this.format),this.chapterList=this.parser.getChapter(),this.parser.renderComic(),this.renderImage(s);var i,r=yield this.parser.getImgRatio(),n=window.frames[0].document.getElementById(s+"").clientWidth*r;let e=window.frames[0].document.getElementsByTagName("img");for(let t=0;t<e.length;t++)"scroll"===this.mode?e[t].style.height=n+"px":(i="single"===this.mode?1:2,n>this.element.clientHeight?(e[t].style.height=this.element.clientHeight+"px",e[t].style.width=this.element.clientHeight/r+"px",e[t].style.paddingLeft=(this.element.clientWidth-("single"===this.mode?0:88))/2/i-this.element.clientHeight/r/2+"px"):(e[t].style.height=n+"px",e[t].style.marginTop=this.element.clientHeight/2-n/2+"px"));Ye(o,this.mode),Qe(o,this.mode),this.trigger("rendered"),t()}else t()}))}renderImage(e){var i=e+4<this.dataSource.length?e+4:this.dataSource.length;for(let t=0<e-4?e-4:0;t<i;t++)this.parser.renderImage(t)}getChapter(){return this.chapterList}goToPosition(t,e,i){wi(this.element,this.mode,i)}goToChapter(t){wi(this.element,this.mode,this.dataSource.indexOf(t)+""),this.renderImage(this.dataSource.indexOf(t))}record(){oi(this.element,this.mode);var e=parseInt(s.getKookitConfig("count"))||0;if(!(1<this.largestId-e)){var i=e+10<this.dataSource.length-1?e+10:this.dataSource.length-1;for(let t=e;t<i;t++)this.parser.renderImage(t);this.largestId=e+i-1}}prev(){var e=parseInt(s.getKookitConfig("count"))||0;if(0<e){var i=e+4<this.dataSource.length?e+3:this.dataSource.length;for(let t=0<e-4?e-4:0;t<i;t++)this.parser.renderImage(t)}yi(this.element,1),oi(this.element,this.mode)}next(){var e=parseInt(s.getKookitConfig("count"))||0;if(e<this.dataSource.length-1){var i=e+4<this.dataSource.length-1?e+4:this.dataSource.length-1;for(let t=0<e-4?e-4:0;t<i;t++)this.parser.renderImage(t)}yi(this.element,-1),oi(this.element,this.mode)}getPosition(){return{text:s.getKookitConfig("text"),chapterTitle:s.getKookitConfig("chapterTitle"),count:s.getKookitConfig("count")}}setStyle(t){window.frames[0].document.body.setAttribute("style",t+window.frames[0].document.body.getAttribute("style"))}},t.MobiRender=class extends ci{constructor(t,e){super(),this.mobiBuffer=t,this.mode=e,this.chapterList=[],this.chapterDocList=[],this.bookStr="",this.element=""}renderTo(r){return new Promise((i,t)=>n(this,void 0,void 0,function*(){if(yield f()){var e=(yield new pi(this.mobiBuffer).render()).outerHTML;this.bookStr=e,this.element=r;let t=new hi(this.bookStr);this.chapterDocList=t.getChapterDoc(),this.chapterList=t.getChapter();e=s.getKookitConfig("chapterTitle")||this.chapterDocList[0].title;Xe(r),Ye(r,this.mode),ri(e,this.chapterDocList,this.element,this.mode),this.trigger("rendered"),i()}else i()}))}getChapter(){return this.chapterList}goToChapter(t){ri(t,this.chapterDocList,this.element,this.mode)}goToPosition(t,e,i){ri(e,this.chapterDocList,this.element,this.mode),ni(this.element,this.mode,t,i)}prev(){"scroll"===this.mode||0===window.frames[0].document.body.scrollLeft?ii(this.element,this.chapterList,this.chapterDocList,this.mode):ei(this.element,this.chapterList,this.chapterDocList,this.mode,1),oi(this.element,this.mode)}next(){Math.abs(window.frames[0].document.body.scrollWidth-window.frames[0].document.body.scrollLeft-window.frames[0].document.body.clientWidth)<10||"scroll"===this.mode?si(this.element,this.chapterList,this.chapterDocList,this.mode):ei(this.element,this.chapterList,this.chapterDocList,this.mode,-1),oi(this.element,this.mode)}record(){oi(this.element,this.mode)}getPosition(){return{text:s.getKookitConfig("text"),chapterTitle:s.getKookitConfig("chapterTitle"),count:s.getKookitConfig("count")}}setStyle(t){window.frames[0].document.body.setAttribute("style",t+window.frames[0].document.body.getAttribute("style"))}},t.StrRender=class extends ci{constructor(t,e){super(),this.bookStr=t,this.mode=e,this.chapterList=[],this.chapterDocList=[],this.element=""}renderTo(r){return new Promise((i,t)=>n(this,void 0,void 0,function*(){if(yield f()){this.element=r;let t=new li(this.bookStr);this.chapterList=t.getChapter(),this.chapterDocList=t.getChapterDoc();var e=s.getKookitConfig("chapterTitle")||this.chapterDocList[0].title;Xe(r),ri(e,this.chapterDocList,this.element,this.mode),Ye(r,this.mode),this.trigger("rendered"),i()}else i()}))}getChapter(){return this.chapterList}goToChapter(t){ri(t,this.chapterDocList,this.element,this.mode)}goToPosition(t,e,i){ri(e,this.chapterDocList,this.element,this.mode),ni(this.element,this.mode,t,i)}record(){oi(this.element,this.mode)}prev(){"scroll"===this.mode||0===window.frames[0].document.body.scrollLeft?ii(this.element,this.chapterList,this.chapterDocList,this.mode):ei(this.element,this.chapterList,this.chapterDocList,this.mode,1),oi(this.element,this.mode)}next(){Math.abs(window.frames[0].document.body.scrollWidth-window.frames[0].document.body.scrollLeft-window.frames[0].document.body.clientWidth)<10||"scroll"===this.mode?si(this.element,this.chapterList,this.chapterDocList,this.mode):ei(this.element,this.chapterList,this.chapterDocList,this.mode,-1),oi(this.element,this.mode)}getPosition(){return{text:s.getKookitConfig("text"),chapterTitle:s.getKookitConfig("chapterTitle"),count:s.getKookitConfig("count")}}setStyle(t){window.frames[0].document.body.setAttribute("style",t+window.frames[0].document.body.getAttribute("style"))}},t.TxtRender=class extends ci{constructor(t,e,i="utf-8"){super(),this.txtBuffer=t,this.encoding=i,this.mode=e,this.chapterList=[],this.chapterDocList=[],this.bookStr="",this.element=""}renderTo(r){return new Promise((i,t)=>n(this,void 0,void 0,function*(){if(yield f()){var e=(t=>{let e="",i=!1;var r;for(r of t.split("\n"))r.trim()&&(a(r.trim(),i)?((r.trim().startsWith("第")||r.trim().startsWith("Chapter")||r.trim().startsWith("CHAPTER"))&&(i=!0),e+=`<h1>${r}</h1>`):e+=`<p>${r}</p>`);return e})(new TextDecoder(this.encoding).decode(this.txtBuffer));this.bookStr=e,this.element=r;let t=new gi(this.bookStr);this.chapterList=t.getChapter(),this.chapterDocList=t.getChapterDoc();e=s.getKookitConfig("chapterTitle")||this.chapterDocList[0].title;Xe(r),Ye(r,this.mode),ri(e,this.chapterDocList,this.element,this.mode),this.trigger("rendered"),i()}else i()}))}getChapter(){return this.chapterList}goToChapter(t){ri(t,this.chapterDocList,this.element,this.mode)}goToPosition(t,e,i){ri(e,this.chapterDocList,this.element,this.mode),ni(this.element,this.mode,t,i)}record(){oi(this.element,this.mode)}prev(){"scroll"===this.mode||0===window.frames[0].document.body.scrollLeft?ii(this.element,this.chapterList,this.chapterDocList,this.mode):ei(this.element,this.chapterList,this.chapterDocList,this.mode,1),oi(this.element,this.mode)}next(){Math.abs(window.frames[0].document.body.scrollWidth-window.frames[0].document.body.scrollLeft-window.frames[0].document.body.clientWidth)<10||"scroll"===this.mode?si(this.element,this.chapterList,this.chapterDocList,this.mode):ei(this.element,this.chapterList,this.chapterDocList,this.mode,-1),oi(this.element,this.mode)}getPosition(){return{text:s.getKookitConfig("text"),chapterTitle:s.getKookitConfig("chapterTitle"),count:s.getKookitConfig("count")}}setStyle(t){window.frames[0].document.body.setAttribute("style",t+window.frames[0].document.body.getAttribute("style"))}},Object.defineProperty(t,"__esModule",{value:!0})});
