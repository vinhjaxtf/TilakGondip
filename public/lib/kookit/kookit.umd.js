!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Kookit={})}(this,function(t){"use strict";function n(t,s,a,h){return new(a=a||Promise)(function(r,e){function i(t){try{o(h.next(t))}catch(t){e(t)}}function n(t){try{o(h.throw(t))}catch(t){e(t)}}function o(t){var e;t.done?r(t.value):((e=t.value)instanceof a?e:new a(function(t){t(e)})).then(i,n)}o((h=h.apply(t,s||[])).next())})}class s{static getKookitConfig(t){return(JSON.parse(localStorage.getItem("kookitConfig"))||{})[t]}static setKookitConfig(t,e){let r=JSON.parse(localStorage.getItem("kookitConfig"))||{};r[t]=e,localStorage.setItem("kookitConfig",JSON.stringify(r))}static removeKookitConfig(){localStorage.removeItem("kookitConfig")}}let i=["章","节","回","節","卷","部","輯","辑","話","集","话","篇"];String.prototype.contains=function(t){return-1<this.indexOf(t)};const a=(t,e=!1)=>t&&!t.contains("[")&&!t.contains("(")&&!t.contains("。")&&!t.contains("“")&&!t.contains("‘")&&!t.contains("；")&&!t.contains(";")&&!t.contains("…")&&(t.startsWith("CHAPTER")||t.startsWith("Chapter")||t.startsWith("序章")||t.startsWith("前言")||t.startsWith("声明")||t.startsWith("聲明")||t.startsWith("写在前面的话")||t.startsWith("后记")||t.startsWith("楔子")||t.startsWith("后序")||t.startsWith("寫在前面的話")||t.startsWith("後記")||t.startsWith("後序")||t.startsWith("第")&&r(t)||t.startsWith("卷")&&o(t)||!e&&t.contains("第")&&(" "===t[t.indexOf("第")-1]||"　"===t[t.indexOf("第")-1]||"、"===t[t.indexOf("第")-1]||"："===t[t.indexOf("第")-1]||":"===t[t.indexOf("第")-1])&&r(t.substr(t.indexOf("第")))||!e&&t.indexOf(" ")&&h(t)||!e&&t.indexOf("　")&&h(t)||!e&&t.indexOf("、")&&c(t)||!e&&t.indexOf("：")&&l(t)||!e&&t.indexOf(":")&&l(t)),r=e=>{let r=!1;for(let t=0;t<i.length&&(!(-1<e.indexOf(i[t])&&(" "===e[e.indexOf(i[t])+1]||"　"===e[e.indexOf(i[t])+1]||"、"===e[e.indexOf(i[t])+1]||"："===e[e.indexOf(i[t])+1]||-1<e.indexOf("章")||":"===e[e.indexOf(i[t])+1]))&&e[e.indexOf(i[t])+1]||((/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(e.substring(1,e.indexOf(i[t])).trim())||/^\d+$/.test(e.substring(1,e.indexOf(i[t])).trim()))&&(r=!0),!r));t++);return r},o=t=>!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(t.substring(1,t.indexOf(" ")))&&!/^\d+$/.test(t.substring(1,t.indexOf(" "))))||(!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(t.substring(1,t.indexOf("　")))&&!/^\d+$/.test(t.substring(1,t.indexOf("　"))))||!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(t.substring(1))&&!/^\d+$/.test(t.substring(1)))),h=t=>!!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(t.substring(0,t.indexOf(" ")))||(!!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(t.substring(0,t.indexOf("　")))||(!!/^\d+$/.test(t.substring(0,t.indexOf(" ")))||!!/^\d+$/.test(t.substring(0,t.indexOf("　"))))),l=t=>!!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(t.substring(0,t.indexOf(":")))||(!!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(t.substring(0,t.indexOf("：")))||(!!/^\d+$/.test(t.substring(0,t.indexOf(":")))||!!/^\d+$/.test(t.substring(0,t.indexOf("："))))),c=t=>!!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c]+$/.test(t.substring(0,t.indexOf("、")))||!!/^\d+$/.test(t.substring(0,t.indexOf("、")));var u=window;var e=window.atob("ZG8gUmU=");String.prototype.c=function(t){return-1<this.indexOf(t)};const f=()=>n(void 0,void 0,void 0,function*(){s.removeKookitConfig();let t=yield new Promise((t,e)=>{t(u.e(u.a("ZG9jdW1lbnQudGl0bGU=")))});return!!t.c(e)});var d="1.13.1",m="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||Function("return this")()||{},p=Array.prototype,g=Object.prototype,b="undefined"!=typeof Symbol?Symbol.prototype:null,v=p.push,y=p.slice,w=g.toString,x=g.hasOwnProperty,L="undefined"!=typeof ArrayBuffer,T="undefined"!=typeof DataView,k=Array.isArray,_=Object.keys,D=Object.create,C=L&&ArrayBuffer.isView,S=isNaN,O=isFinite,A=!{toString:null}.propertyIsEnumerable("toString"),M=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],U=Math.pow(2,53)-1;function E(n,o){return o=null==o?n.length-1:+o,function(){for(var t=Math.max(arguments.length-o,0),e=Array(t),r=0;r<t;r++)e[r]=arguments[r+o];switch(o){case 0:return n.call(this,e);case 1:return n.call(this,arguments[0],e);case 2:return n.call(this,arguments[0],arguments[1],e)}for(var i=Array(o+1),r=0;r<o;r++)i[r]=arguments[r];return i[o]=e,n.apply(this,i)}}function I(t){var e=typeof t;return"function"==e||"object"==e&&!!t}function j(t){return void 0===t}function N(t){return!0===t||!1===t||"[object Boolean]"===w.call(t)}function W(t){var e="[object "+t+"]";return function(t){return w.call(t)===e}}var B=W("String"),z=W("Number"),H=W("Date"),P=W("RegExp"),K=W("Error"),$=W("Symbol"),R=W("ArrayBuffer"),F=W("Function"),q=m.document&&m.document.childNodes,V=F="function"!=typeof/./&&"object"!=typeof Int8Array&&"function"!=typeof q?function(t){return"function"==typeof t||!1}:F,G=W("Object"),J=T&&G(new DataView(new ArrayBuffer(8))),Z="undefined"!=typeof Map&&G(new Map),Q=W("DataView");var X=J?function(t){return null!=t&&V(t.getInt8)&&R(t.buffer)}:Q,Y=k||W("Array");function tt(t,e){return null!=t&&x.call(t,e)}var et=W("Arguments");!function(){et(arguments)||(et=function(t){return tt(t,"callee")})}();var rt=et;function it(t){return z(t)&&S(t)}function nt(t){return function(){return t}}function ot(e){return function(t){t=e(t);return"number"==typeof t&&0<=t&&t<=U}}function st(e){return function(t){return null==t?void 0:t[e]}}var at=st("byteLength"),ht=ot(at),lt=/\[object ((I|Ui)nt(8|16|32)|Float(32|64)|Uint8Clamped|Big(I|Ui)nt64)Array\]/;var ct=L?function(t){return C?C(t)&&!X(t):ht(t)&&lt.test(w.call(t))}:nt(!1),ut=st("length");function ft(t,e){e=function(e){for(var r={},t=e.length,i=0;i<t;++i)r[e[i]]=!0;return{contains:function(t){return r[t]},push:function(t){return r[t]=!0,e.push(t)}}}(e);var r=M.length,i=t.constructor,n=V(i)&&i.prototype||g,o="constructor";for(tt(t,o)&&!e.contains(o)&&e.push(o);r--;)(o=M[r])in t&&t[o]!==n[o]&&!e.contains(o)&&e.push(o)}function dt(t){if(!I(t))return[];if(_)return _(t);var e,r=[];for(e in t)tt(t,e)&&r.push(e);return A&&ft(t,r),r}function mt(t,e){var r=dt(e),i=r.length;if(null==t)return!i;for(var n=Object(t),o=0;o<i;o++){var s=r[o];if(e[s]!==n[s]||!(s in n))return!1}return!0}function pt(t){return t instanceof pt?t:this instanceof pt?void(this._wrapped=t):new pt(t)}function gt(t){return new Uint8Array(t.buffer||t,t.byteOffset||0,at(t))}pt.VERSION=d,pt.prototype.valueOf=pt.prototype.toJSON=pt.prototype.value=function(){return this._wrapped},pt.prototype.toString=function(){return String(this._wrapped)};var bt="[object DataView]";function vt(t,e,r,i){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return!1;if(t!=t)return e!=e;var n=typeof t;return("function"==n||"object"==n||"object"==typeof e)&&function t(e,r,i,n){e instanceof pt&&(e=e._wrapped);r instanceof pt&&(r=r._wrapped);var o=w.call(e);if(o!==w.call(r))return!1;if(J&&"[object Object]"==o&&X(e)){if(!X(r))return!1;o=bt}switch(o){case"[object RegExp]":case"[object String]":return""+e==""+r;case"[object Number]":return+e!=+e?+r!=+r:0==+e?1/+e==1/r:+e==+r;case"[object Date]":case"[object Boolean]":return+e==+r;case"[object Symbol]":return b.valueOf.call(e)===b.valueOf.call(r);case"[object ArrayBuffer]":case bt:return t(gt(e),gt(r),i,n)}var s="[object Array]"===o;if(!s&&ct(e)){var a=at(e);if(a!==at(r))return!1;if(e.buffer===r.buffer&&e.byteOffset===r.byteOffset)return!0;s=!0}if(!s){if("object"!=typeof e||"object"!=typeof r)return!1;o=e.constructor,a=r.constructor;if(o!==a&&!(V(o)&&o instanceof o&&V(a)&&a instanceof a)&&"constructor"in e&&"constructor"in r)return!1}i=i||[];n=n||[];var h=i.length;for(;h--;)if(i[h]===e)return n[h]===r;i.push(e);n.push(r);if(s){if((h=e.length)!==r.length)return!1;for(;h--;)if(!vt(e[h],r[h],i,n))return!1}else{var l,c=dt(e);if(h=c.length,dt(r).length!==h)return!1;for(;h--;)if(l=c[h],!tt(r,l)||!vt(e[l],r[l],i,n))return!1}i.pop();n.pop();return!0}(t,e,r,i)}function yt(t){if(!I(t))return[];var e,r=[];for(e in t)r.push(e);return A&&ft(t,r),r}function wt(i){var n=ut(i);return function(t){if(null==t)return!1;var e=yt(t);if(ut(e))return!1;for(var r=0;r<n;r++)if(!V(t[i[r]]))return!1;return i!==_t||!V(t[xt])}}var xt="forEach",Lt=["clear","delete"],Tt=["get","has","set"],kt=Lt.concat(xt,Tt),_t=Lt.concat(Tt),Dt=["add"].concat(Lt,xt,"has"),Ct=Z?wt(kt):W("Map"),St=Z?wt(_t):W("WeakMap"),Ot=Z?wt(Dt):W("Set"),At=W("WeakSet");function Mt(t){for(var e=dt(t),r=e.length,i=Array(r),n=0;n<r;n++)i[n]=t[e[n]];return i}function Ut(t){for(var e={},r=dt(t),i=0,n=r.length;i<n;i++)e[t[r[i]]]=r[i];return e}function Et(t){var e,r=[];for(e in t)V(t[e])&&r.push(e);return r.sort()}function It(h,l){return function(t){var e=arguments.length;if(l&&(t=Object(t)),e<2||null==t)return t;for(var r=1;r<e;r++)for(var i=arguments[r],n=h(i),o=n.length,s=0;s<o;s++){var a=n[s];l&&void 0!==t[a]||(t[a]=i[a])}return t}}var jt=It(yt),Nt=It(dt),Wt=It(yt,!0);function Bt(t){if(!I(t))return{};if(D)return D(t);var e=function(){};e.prototype=t;t=new e;return e.prototype=null,t}function zt(t){return I(t)?Y(t)?t.slice():jt({},t):t}function Ht(t){return Y(t)?t:[t]}function Pt(t){return pt.toPath(t)}function Kt(t,e){for(var r=e.length,i=0;i<r;i++){if(null==t)return;t=t[e[i]]}return r?t:void 0}function $t(t,e,r){e=Kt(t,Pt(e));return j(e)?r:e}function Rt(t){return t}function Ft(e){return e=Nt({},e),function(t){return mt(t,e)}}function qt(e){return e=Pt(e),function(t){return Kt(t,e)}}function Vt(n,o,t){if(void 0===o)return n;switch(null==t?3:t){case 1:return function(t){return n.call(o,t)};case 3:return function(t,e,r){return n.call(o,t,e,r)};case 4:return function(t,e,r,i){return n.call(o,t,e,r,i)}}return function(){return n.apply(o,arguments)}}function Gt(t,e,r){return null==t?Rt:V(t)?Vt(t,e,r):(I(t)&&!Y(t)?Ft:qt)(t)}function Jt(t,e){return Gt(t,e,1/0)}function Zt(t,e,r){return pt.iteratee!==Jt?pt.iteratee(t,e):Gt(t,e,r)}function Qt(){}function Xt(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))}pt.toPath=Ht,pt.iteratee=Jt;var Yt=Date.now||function(){return(new Date).getTime()};function te(e){function r(t){return e[t]}var t="(?:"+dt(e).join("|")+")",i=RegExp(t),n=RegExp(t,"g");return function(t){return i.test(t=null==t?"":""+t)?t.replace(n,r):t}}var ee={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},re=te(ee),ie=te(Ut(ee)),ne=pt.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},oe=/(.)^/,se={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},ae=/\\|'|\r|\n|\u2028|\u2029/g;function he(t){return"\\"+se[t]}var le=/^\s*(\w|\$)+\s*$/;var ce=0;function ue(t,e,r,i,n){if(!(i instanceof e))return t.apply(r,n);r=Bt(t.prototype),n=t.apply(r,n);return I(n)?n:r}var fe=E(function(n,o){function s(){for(var t=0,e=o.length,r=Array(e),i=0;i<e;i++)r[i]=o[i]===a?arguments[t++]:o[i];for(;t<arguments.length;)r.push(arguments[t++]);return ue(n,s,this,this,r)}var a=fe.placeholder;return s});fe.placeholder=pt;var de=E(function(e,r,i){if(!V(e))throw new TypeError("Bind must be called on a function");var n=E(function(t){return ue(e,n,r,this,i.concat(t))});return n}),me=ot(ut);function pe(t,e,r,i){if(i=i||[],e||0===e){if(e<=0)return i.concat(t)}else e=1/0;for(var n=i.length,o=0,s=ut(t);o<s;o++){var a=t[o];if(me(a)&&(Y(a)||rt(a)))if(1<e)pe(a,e-1,r,i),n=i.length;else for(var h=0,l=a.length;h<l;)i[n++]=a[h++];else r||(i[n++]=a)}return i}var ge=E(function(t,e){var r=(e=pe(e,!1,!1)).length;if(r<1)throw new Error("bindAll must be passed function names");for(;r--;){var i=e[r];t[i]=de(t[i],t)}return t});var be=E(function(t,e,r){return setTimeout(function(){return t.apply(null,r)},e)}),ve=fe(be,pt,1);function ye(t){return function(){return!t.apply(this,arguments)}}function we(t,e){var r;return function(){return 0<--t&&(r=e.apply(this,arguments)),t<=1&&(e=null),r}}m=fe(we,2);function xe(t,e,r){e=Zt(e,r);for(var i,n=dt(t),o=0,s=n.length;o<s;o++)if(e(t[i=n[o]],i,t))return i}function Le(o){return function(t,e,r){e=Zt(e,r);for(var i=ut(t),n=0<o?0:i-1;0<=n&&n<i;n+=o)if(e(t[n],n,t))return n;return-1}}var Te=Le(1),q=Le(-1);function ke(t,e,r,i){for(var n=(r=Zt(r,i,1))(e),o=0,s=ut(t);o<s;){var a=Math.floor((o+s)/2);r(t[a])<n?o=a+1:s=a}return o}function _e(o,s,a){return function(t,e,r){var i=0,n=ut(t);if("number"==typeof r)0<o?i=0<=r?r:Math.max(r+n,i):n=0<=r?Math.min(r+1,n):r+n+1;else if(a&&r&&n)return t[r=a(t,e)]===e?r:-1;if(e!=e)return 0<=(r=s(y.call(t,i,n),it))?r+i:-1;for(r=0<o?i:n-1;0<=r&&r<n;r+=o)if(t[r]===e)return r;return-1}}var De=_e(1,Te,ke),F=_e(-1,q);function Ce(t,e,r){r=(me(t)?Te:xe)(t,e,r);if(void 0!==r&&-1!==r)return t[r]}function Se(t,e,r){if(e=Vt(e,r),me(t))for(n=0,o=t.length;n<o;n++)e(t[n],n,t);else for(var i=dt(t),n=0,o=i.length;n<o;n++)e(t[i[n]],i[n],t);return t}function Oe(t,e,r){e=Zt(e,r);for(var i=!me(t)&&dt(t),n=(i||t).length,o=Array(n),s=0;s<n;s++){var a=i?i[s]:s;o[s]=e(t[a],a,t)}return o}function Ae(h){return function(t,e,r,i){var n=3<=arguments.length;return function(t,e,r,i){var n=!me(t)&&dt(t),o=(n||t).length,s=0<h?0:o-1;for(i||(r=t[n?n[s]:s],s+=h);0<=s&&s<o;s+=h){var a=n?n[s]:s;r=e(r,t[a],a,t)}return r}(t,Vt(e,i,4),r,n)}}T=Ae(1),G=Ae(-1);function Me(t,i,e){var n=[];return i=Zt(i,e),Se(t,function(t,e,r){i(t,e,r)&&n.push(t)}),n}function Ue(t,e,r){e=Zt(e,r);for(var i=!me(t)&&dt(t),n=(i||t).length,o=0;o<n;o++){var s=i?i[o]:o;if(!e(t[s],s,t))return!1}return!0}function Ee(t,e,r){e=Zt(e,r);for(var i=!me(t)&&dt(t),n=(i||t).length,o=0;o<n;o++){var s=i?i[o]:o;if(e(t[s],s,t))return!0}return!1}function Ie(t,e,r,i){return me(t)||(t=Mt(t)),0<=De(t,e,r="number"!=typeof r||i?0:r)}Q=E(function(t,r,i){var n,o;return V(r)?o=r:(r=Pt(r),n=r.slice(0,-1),r=r[r.length-1]),Oe(t,function(t){var e=o;if(!e){if(null==(t=n&&n.length?Kt(t,n):t))return;e=t[r]}return null==e?e:e.apply(t,i)})});function je(t,e){return Oe(t,qt(e))}function Ne(t,i,e){var r,n,o=-1/0,s=-1/0;if(null==i||"number"==typeof i&&"object"!=typeof t[0]&&null!=t)for(var a=0,h=(t=me(t)?t:Mt(t)).length;a<h;a++)null!=(r=t[a])&&o<r&&(o=r);else i=Zt(i,e),Se(t,function(t,e,r){n=i(t,e,r),(s<n||n===-1/0&&o===-1/0)&&(o=t,s=n)});return o}function We(t,e,r){if(null==e||r)return(t=!me(t)?Mt(t):t)[Xt(t.length-1)];var i=(me(t)?zt:Mt)(t),t=ut(i);e=Math.max(Math.min(e,t),0);for(var n=t-1,o=0;o<e;o++){var s=Xt(o,n),a=i[o];i[o]=i[s],i[s]=a}return i.slice(0,e)}function Be(o,e){return function(r,i,t){var n=e?[[],[]]:{};return i=Zt(i,t),Se(r,function(t,e){e=i(t,e,r);o(n,t,e)}),n}}var k=Be(function(t,e,r){tt(t,r)?t[r].push(e):t[r]=[e]}),L=Be(function(t,e,r){t[r]=e}),Tt=Be(function(t,e,r){tt(t,r)?t[r]++:t[r]=1}),Lt=Be(function(t,e,r){t[r?0:1].push(e)},!0),ze=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;function He(t,e,r){return e in r}var Pe=E(function(t,e){var r={},i=e[0];if(null==t)return r;V(i)?(1<e.length&&(i=Vt(i,e[1])),e=yt(t)):(i=He,e=pe(e,!1,!1),t=Object(t));for(var n=0,o=e.length;n<o;n++){var s=e[n],a=t[s];i(a,s,t)&&(r[s]=a)}return r}),kt=E(function(t,r){var e,i=r[0];return V(i)?(i=ye(i),1<r.length&&(e=r[1])):(r=Oe(pe(r,!1,!1),String),i=function(t,e){return!Ie(r,e)}),Pe(t,i,e)});function Ke(t,e,r){return y.call(t,0,Math.max(0,t.length-(null==e||r?1:e)))}function $e(t,e,r){return null==t||t.length<1?null==e||r?void 0:[]:null==e||r?t[0]:Ke(t,t.length-e)}function Re(t,e,r){return y.call(t,null==e||r?1:e)}var Fe=E(function(t,e){return e=pe(e,!0,!0),Me(t,function(t){return!Ie(e,t)})}),Z=E(function(t,e){return Fe(t,e)});function qe(t,e,r,i){N(e)||(i=r,r=e,e=!1),null!=r&&(r=Zt(r,i));for(var n=[],o=[],s=0,a=ut(t);s<a;s++){var h=t[s],l=r?r(h,s,t):h;e&&!r?(s&&o===l||n.push(h),o=l):r?Ie(o,l)||(o.push(l),n.push(h)):Ie(n,h)||n.push(h)}return n}Dt=E(function(t){return qe(pe(t,!0,!0))});function Ve(t){for(var e=t&&Ne(t,ut).length||0,r=Array(e),i=0;i<e;i++)r[i]=je(t,i);return r}ee=E(Ve);function Ge(t,e){return t._chain?pt(e).chain():e}function Je(r){return Se(Et(r),function(t){var e=pt[t]=r[t];pt.prototype[t]=function(){var t=[this._wrapped];return v.apply(t,arguments),Ge(this,e.apply(pt,t))}}),pt}Se(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var r=p[e];pt.prototype[e]=function(){var t=this._wrapped;return null!=t&&(r.apply(t,arguments),"shift"!==e&&"splice"!==e||0!==t.length||delete t[0]),Ge(this,t)}}),Se(["concat","join","slice"],function(t){var e=p[t];pt.prototype[t]=function(){var t=this._wrapped;return Ge(this,t=null!=t?e.apply(t,arguments):t)}});var Ze=Je(Object.freeze({__proto__:null,VERSION:d,restArguments:E,isObject:I,isNull:function(t){return null===t},isUndefined:j,isBoolean:N,isElement:function(t){return!(!t||1!==t.nodeType)},isString:B,isNumber:z,isDate:H,isRegExp:P,isError:K,isSymbol:$,isArrayBuffer:R,isDataView:X,isArray:Y,isFunction:V,isArguments:rt,isFinite:function(t){return!$(t)&&O(t)&&!isNaN(parseFloat(t))},isNaN:it,isTypedArray:ct,isEmpty:function(t){if(null==t)return!0;var e=ut(t);return"number"==typeof e&&(Y(t)||B(t)||rt(t))?0===e:0===ut(dt(t))},isMatch:mt,isEqual:function(t,e){return vt(t,e)},isMap:Ct,isWeakMap:St,isSet:Ot,isWeakSet:At,keys:dt,allKeys:yt,values:Mt,pairs:function(t){for(var e=dt(t),r=e.length,i=Array(r),n=0;n<r;n++)i[n]=[e[n],t[e[n]]];return i},invert:Ut,functions:Et,methods:Et,extend:jt,extendOwn:Nt,assign:Nt,defaults:Wt,create:function(t,e){return t=Bt(t),e&&Nt(t,e),t},clone:zt,tap:function(t,e){return e(t),t},get:$t,has:function(t,e){for(var r=(e=Pt(e)).length,i=0;i<r;i++){var n=e[i];if(!tt(t,n))return!1;t=t[n]}return!!r},mapObject:function(t,e,r){e=Zt(e,r);for(var i=dt(t),n=i.length,o={},s=0;s<n;s++){var a=i[s];o[a]=e(t[a],a,t)}return o},identity:Rt,constant:nt,noop:Qt,toPath:Ht,property:qt,propertyOf:function(e){return null==e?Qt:function(t){return $t(e,t)}},matcher:Ft,matches:Ft,times:function(t,e,r){var i=Array(Math.max(0,t));e=Vt(e,r,1);for(var n=0;n<t;n++)i[n]=e(n);return i},random:Xt,now:Yt,escape:re,unescape:ie,templateSettings:ne,template:function(o,t,e){t=Wt({},t=!t&&e?e:t,pt.templateSettings);var r,e=RegExp([(t.escape||oe).source,(t.interpolate||oe).source,(t.evaluate||oe).source].join("|")+"|$","g"),s=0,a="__p+='";if(o.replace(e,function(t,e,r,i,n){return a+=o.slice(s,n).replace(ae,he),s=n+t.length,e?a+="'+\n((__t=("+e+"))==null?'':_.escape(__t))+\n'":r?a+="'+\n((__t=("+r+"))==null?'':__t)+\n'":i&&(a+="';\n"+i+"\n__p+='"),t}),a+="';\n",e=t.variable){if(!le.test(e))throw new Error("variable is not a bare identifier: "+e)}else a="with(obj||{}){\n"+a+"}\n",e="obj";a="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{r=new Function(e,"_",a)}catch(t){throw t.source=a,t}return(t=function(t){return r.call(this,t,pt)}).source="function("+e+"){\n"+a+"}",t},result:function(t,e,r){var i=(e=Pt(e)).length;if(!i)return V(r)?r.call(t):r;for(var n=0;n<i;n++){var o=null==t?void 0:t[e[n]];void 0===o&&(o=r,n=i),t=V(o)?o.call(t):o}return t},uniqueId:function(t){var e=++ce+"";return t?t+e:e},chain:function(t){return(t=pt(t))._chain=!0,t},iteratee:Jt,partial:fe,bind:de,bindAll:ge,memoize:function(r,i){function n(t){var e=n.cache,t=""+(i?i.apply(this,arguments):t);return tt(e,t)||(e[t]=r.apply(this,arguments)),e[t]}return n.cache={},n},delay:be,defer:ve,throttle:function(r,i,n){var o,s,a,h,l=0;function c(){l=!1===n.leading?0:Yt(),o=null,h=r.apply(s,a),o||(s=a=null)}function t(){var t=Yt();l||!1!==n.leading||(l=t);var e=i-(t-l);return s=this,a=arguments,e<=0||i<e?(o&&(clearTimeout(o),o=null),l=t,h=r.apply(s,a),o||(s=a=null)):o||!1===n.trailing||(o=setTimeout(c,e)),h}return n=n||{},t.cancel=function(){clearTimeout(o),l=0,o=s=a=null},t},debounce:function(e,r,i){function n(){var t=Yt()-s;t<r?o=setTimeout(n,r-t):(o=null,i||(h=e.apply(l,a)),o||(a=l=null))}var o,s,a,h,l,t=E(function(t){return l=this,a=t,s=Yt(),o||(o=setTimeout(n,r),i&&(h=e.apply(l,a))),h});return t.cancel=function(){clearTimeout(o),o=a=l=null},t},wrap:function(t,e){return fe(e,t)},negate:ye,compose:function(){var r=arguments,i=r.length-1;return function(){for(var t=i,e=r[i].apply(this,arguments);t--;)e=r[t].call(this,e);return e}},after:function(t,e){return function(){if(--t<1)return e.apply(this,arguments)}},before:we,once:m,findKey:xe,findIndex:Te,findLastIndex:q,sortedIndex:ke,indexOf:De,lastIndexOf:F,find:Ce,detect:Ce,findWhere:function(t,e){return Ce(t,Ft(e))},each:Se,forEach:Se,map:Oe,collect:Oe,reduce:T,foldl:T,inject:T,reduceRight:G,foldr:G,filter:Me,select:Me,reject:function(t,e,r){return Me(t,ye(Zt(e)),r)},every:Ue,all:Ue,some:Ee,any:Ee,contains:Ie,includes:Ie,include:Ie,invoke:Q,pluck:je,where:function(t,e){return Me(t,Ft(e))},max:Ne,min:function(t,i,e){var r,n,o=1/0,s=1/0;if(null==i||"number"==typeof i&&"object"!=typeof t[0]&&null!=t)for(var a=0,h=(t=me(t)?t:Mt(t)).length;a<h;a++)null!=(r=t[a])&&r<o&&(o=r);else i=Zt(i,e),Se(t,function(t,e,r){((n=i(t,e,r))<s||n===1/0&&o===1/0)&&(o=t,s=n)});return o},shuffle:function(t){return We(t,1/0)},sample:We,sortBy:function(t,i,e){var n=0;return i=Zt(i,e),je(Oe(t,function(t,e,r){return{value:t,index:n++,criteria:i(t,e,r)}}).sort(function(t,e){var r=t.criteria,i=e.criteria;if(r!==i){if(i<r||void 0===r)return 1;if(r<i||void 0===i)return-1}return t.index-e.index}),"value")},groupBy:k,indexBy:L,countBy:Tt,partition:Lt,toArray:function(t){return t?Y(t)?y.call(t):B(t)?t.match(ze):me(t)?Oe(t,Rt):Mt(t):[]},size:function(t){return null==t?0:(me(t)?t:dt(t)).length},pick:Pe,omit:kt,first:$e,head:$e,take:$e,initial:Ke,last:function(t,e,r){return null==t||t.length<1?null==e||r?void 0:[]:null==e||r?t[t.length-1]:Re(t,Math.max(0,t.length-e))},rest:Re,tail:Re,drop:Re,compact:function(t){return Me(t,Boolean)},flatten:function(t,e){return pe(t,e,!1)},without:Z,uniq:qe,unique:qe,union:Dt,intersection:function(t){for(var e=[],r=arguments.length,i=0,n=ut(t);i<n;i++){var o=t[i];if(!Ie(e,o)){for(var s=1;s<r&&Ie(arguments[s],o);s++);s===r&&e.push(o)}}return e},difference:Fe,unzip:Ve,transpose:Ve,zip:ee,object:function(t,e){for(var r={},i=0,n=ut(t);i<n;i++)e?r[t[i]]=e[i]:r[t[i][0]]=t[i][1];return r},range:function(t,e,r){null==e&&(e=t||0,t=0),r=r||(e<t?-1:1);for(var i=Math.max(Math.ceil((e-t)/r),0),n=Array(i),o=0;o<i;o++,t+=r)n[o]=t;return n},chunk:function(t,e){if(null==e||e<1)return[];for(var r=[],i=0,n=t.length;i<n;)r.push(y.call(t,i,i+=e));return r},mixin:Je,default:pt}));Ze._=Ze;const Qe=(t,e)=>{let r=document.getElementsByTagName("iframe")[0];var i;"scroll"===e?(i=r.contentWindow.document.body,e=r.contentWindow.document.documentElement,r.height=2*Math.max(i.scrollHeight,i.offsetHeight,e.clientHeight,e.scrollHeight,e.offsetHeight),setTimeout(()=>{let t=document.getElementsByTagName("iframe")[0],e=t.contentWindow.document.body;var r=e.lastElementChild,i=e.lastChild,n=e.getElementsByTagName("a"),o=e.getElementsByTagName("p"),s=e.getElementsByTagName("img"),a=n[n.length-1],n=o[o.length-1],s=o[s.length-1];let h=n||a||s;Ze.isElement(a)&&Ze.isElement(n)&&(h=a.clientHeight+a.offsetTop>n.clientHeight+n.offsetTop?a:n),Ze.isElement(s)&&s.clientHeight+s.offsetTop>h.clientHeight+h.offsetTop&&(h=s);let l=0;if((r||h||i)&&(3!==i.nodeType||r||h)){if(3===i.nodeType&&document.createRange){let t=document.createRange();t.selectNodeContents(i),!t.getBoundingClientRect||(s=t.getBoundingClientRect())&&(l=s.bottom-s.top)}t.height=Math.max(Ze.isElement(r)?r.clientHeight+r.offsetTop:0,Ze.isElement(i)?i.clientHeight+i.offsetTop:0,Ze.isElement(h)?h.clientHeight+h.offsetTop:0)+400+(3===i.nodeType?l:0)}},500)):r.height=t.offsetHeight},Xe=t=>{var e=document.createElement("iframe");e.style.width="100%",e.style.border="0",e.style.margin="0",e.style.padding="0",e.style.fontSize="100%",e.style.font="inherit",e.style.verticalAlign="baseline",t.innerHTML="",t.appendChild(e)},Ye=(t,e)=>{"scroll"!==e&&window.frames[0].document.body.setAttribute("style",`width: auto;
    height: 100%;
    overflow-y: hidden;
    overflow-X: hidden;
    padding-left: 0px;
    padding-right: 0px;
    margin: 0px !important;
    box-sizing: border-box;
    max-width: inherit;
    column-fill: auto;
    column-gap: 88px;
    column-count: 12;
    column-width: ${(t.offsetWidth-88)/("double"===e?2:1)}px;`)};let tr=!1;const er=(t,e,r,i,n)=>{0<n&&0<window.frames[0].document.body.scrollLeft?window.frames[0].document.body.scrollLeft-=t.offsetWidth+88:0<n&&0===window.frames[0].document.body.scrollLeft?rr(t,e,r,i):n<0&&(((t,e,r,i)=>{if(Math.abs(t.scrollHeight-t.scrollTop-t.clientHeight)<10&&Math.abs(window.frames[0].document.body.scrollWidth-window.frames[0].document.body.scrollLeft-window.frames[0].document.body.clientWidth)<10)sr(t,e,r,i)})(t,e,r,i),window.frames[0].document.body.scrollLeft+=t.offsetWidth+88)},rr=(t,e,r,i)=>{var n=s.getKookitConfig("chapterTitle"),o=Ze.findIndex(e,{label:n});0!==o&&-1!==o&&n&&(s.setKookitConfig("chapterTitle",e[o-1].label),s.setKookitConfig("text","prevChapter"),ir(e[o-1].label,r,t,i))},ir=(t="",e,r,i)=>{window.frames[0].document.body.innerHTML="";let n=Ze.findIndex(e,{title:t});n=-1===n?0:n,window.frames[0].document.body.innerHTML=e[n].text,s.setKookitConfig("chapterTitle",e[n].title),Qe(r,i),(()=>{var i,t=document.getElementsByTagName("iframe")[0];if(t){let r=t.contentDocument;if(r){let t,e;for(i of r.getElementsByTagName("img")){var n=i.parentElement;i.width&&i.height?i.height/i.width>n.clientHeight/n.clientWidth?(t=n.clientHeight,e=t*i.width/i.height):(e=n.clientWidth,t=e*i.height/i.width):e=n.clientWidth,i.setAttribute("style",`max-width: ${e}px;max-height:${t}px`)}}}})(),nr(r,i)},nr=(e,r,i="",n="0")=>{let o=i||s.getKookitConfig("text")||"";if(o){let t=Array.from(window.frames[0].document.body.querySelectorAll("h1,h2,h3,h4,p,img"));console.log(n);i=t.filter((t,e)=>t.innerText===o&&e===parseInt(s.getKookitConfig("count")||n));console.log(i);i=i[0];"scroll"!==r?window.frames[0].document.body.scrollTo(o&&i?i.offsetLeft:"prevChapter"===o?window.frames[0].document.body.scrollWidth:0,0):e.scrollTo(0,o&&i?i.offsetTop:0)}else("scroll"!==r?window.frames[0].document.body:e).scrollTo(0,0)},or=(r,i)=>{if(!tr){var t=Array.from(window.frames[0].document.body.querySelectorAll("h1,h2,h3,h4,p,img")).filter(t=>ar(r,t,i)&&t.innerText.trim()),n=t["scroll"===i?Math.floor(t.length/2):0];let e=0;var o=Array.from(window.frames[0].document.body.querySelectorAll("h1,h2,h3,h4,p,img"));for(let t=0;t<o.length;t++){if(ar(r,o[t],i)){e=t;break}if(ar(r,o[t],i)&&n&&o[t].innerHTML===n.innerHTML&&"IMG"!==o[t].tagName){e=t;break}}s.setKookitConfig("text",n?n.innerText:""),s.setKookitConfig("count",e+""),tr=!0,setTimeout(()=>{tr=!1},100)}},sr=(t,e,r,i)=>{var n=s.getKookitConfig("chapterTitle"),n=Ze.findIndex(e,{label:n});n!==e.length-1&&-1!==n&&(s.setKookitConfig("chapterTitle",e[n+1].label),s.setKookitConfig("text",""),ir(e[n+1].label,r,t,i))},ar=(t,e,r)=>{var i=!1,n=e.getBoundingClientRect();return"scroll"!==r&&(e.innerText.trim()||e.id&&"IMG"===e.tagName)?i=0<=(r=n.left)&&r<=t.offsetWidth:(e.innerText.trim()||e.id&&"IMG"===e.tagName)&&(i=(n=n.top)>=t.scrollTop&&n<=t.scrollTop+t.offsetHeight),i};class hr{constructor(t){this.bookStr=t,this.chapterList=[],this.chapterDocList=[]}getChapterDoc(){var e=-1<this.bookStr.indexOf("<mbp:pagebreak>")?this.bookStr.split("<mbp:pagebreak>"):this.bookStr.split("<address> </address>");let n=[],o=[],r="";for(let t=0;t<e.length;t++)(t=>{var e=0<t.querySelectorAll("h1,h2,h3,h4,blockquote,font,b").length;let r=t.querySelectorAll("h1,h2,h3,h4,blockquote,font,b"),i=t.getElementsByTagName("p"),n;for(let t=0;t<r.length;t++){var o=n&&("♦"===r[t].innerText.trim()||"●"===r[t].innerText.trim()||"◾"===r[t].innerText.trim()||"◀"===r[t].innerText.trim()||"◼"===r[t].innerText.trim()||"■"===r[t].innerText.trim());if(r[t].innerText.trim()&&!o){n=r[t];break}}for(let t=0;t<i.length&&(!i[t].innerText.trim()||-1!==i[t].innerHTML.indexOf("<"));t++);var s=n&&30<n.innerText.trim().length,t=50<t.body.innerText.length;return e&&(!s||a(n.innerText.trim()))&&t})((new DOMParser).parseFromString(e[t],"text/html"))?(n.push(r+e[t]),r=""):r+=e[t];0===n.length&&n.push(r);for(let i=0;i<n.length;i++){let t=(new DOMParser).parseFromString(n[i],"text/html"),e=t.querySelectorAll("h1,h2,h3,h4,blockquote,font,b"),r;for(let t=0;t<e.length;t++){var s="♦"===e[t].innerText.trim()||"●"===e[t].innerText.trim()||"◾"===e[t].innerText.trim()||"◀"===e[t].innerText.trim()||"◼"===e[t].innerText.trim()||"■"===e[t].innerText.trim();if(e[t].innerText.trim()&&!s){r=e[t];break}}this.chapterDocList.push({title:r?-1===o.indexOf(r.innerText)?r.innerText:r.innerText+"#"+i:"Forword",text:n[i]}),r&&o.push(r.innerText)}return this.chapterDocList}getChapter(){for(let t=0;t<this.chapterDocList.length;t++){var e=Math.floor(9e5*Math.random())+1e5;this.chapterList.push({label:this.chapterDocList[t].title,id:"title"+e,href:"#title"+e,subitems:[]})}return this.chapterList}}class lr{constructor(t){this.bookStr=t,this.chapterList=[],this.chapterDocList=[],this.bookDoc=(new DOMParser).parseFromString(this.bookStr,"text/html"),this.chapterDomList=[]}getChapter(){if(this.chapterDomList=Array.from(this.bookDoc.querySelectorAll("h1,h2,h3,h4,font,b")),0<this.chapterDomList.length){this.insertPageBreak();let t=new hr(this.bookDoc.body.innerHTML);this.chapterDocList=t.getChapterDoc(),this.chapterList=t.getChapter()}else this.getExtraTitle(),this.generateChapterList(),this.insertPageBreak();return this.chapterList}insertPageBreak(){for(let t=0;t<this.chapterDomList.length;t++){var e=document.createElement("address"),r=document.createTextNode(" ");e.appendChild(r),this.chapterDomList[t].parentNode&&this.chapterDomList[t].parentNode.insertBefore(e,this.chapterDomList[t])}}generateChapterList(){var t;0===this.chapterDomList.length&&(t=Math.floor(9e5*Math.random())+1e5,this.chapterList.push({label:"Forword",id:"title"+t,href:"#title"+t,subitems:[]}));let e=[];for(let t=0;t<this.chapterDomList.length;t++){var r=Math.floor(9e5*Math.random())+1e5;this.chapterList.push({label:this.chapterDomList[t]?-1===e.lastIndexOf(this.chapterDomList[t].innerText)?this.chapterDomList[t].innerText:e[e.lastIndexOf(this.chapterDomList[t].innerText)]+"#"+t:"Forword",id:"title"+r,href:"#title"+r,subitems:[]}),e.push(this.chapterList[t].label)}}getExtraTitle(){let e=!1;0===this.chapterDomList.length&&(this.chapterDomList=Array.from(this.bookDoc.getElementsByTagName("p")).filter(t=>(!e&&(t.innerText.trim().startsWith("第")&&r(t.innerText.trim())||t.innerText.trim().startsWith("Chapter")||t.innerText.trim().startsWith("CHAPTER"))&&(e=!0),a(t.innerText.trim(),e))))}getChapterDoc(){if(0<this.chapterDocList.length)return this.chapterDocList;var e,r=this.bookDoc.body.innerHTML.split("<address> </address>");for(let t=0;t<r.length;t++)r.length>this.chapterList.length&&0===t&&(e=Math.floor(9e5*Math.random())+1e5,this.chapterList.unshift({label:"Forword#"+t,id:"title"+e,href:"#title"+e,subitems:[]})),this.chapterDocList.push({title:this.chapterList[t].label,text:r[t]});return this.chapterDocList}}class cr{constructor(){this.callbacks={},this.callbacks.base={}}on(t,e){const r=this;if(void 0===t||""===t)return console.warn("wrong names"),!1;if(void 0===e)return console.warn("wrong callback"),!1;const i=this.resolveNames(t);return i.forEach(function(t){t=r.resolveName(t);r.callbacks[t.namespace]instanceof Object||(r.callbacks[t.namespace]={}),r.callbacks[t.namespace][t.value]instanceof Array||(r.callbacks[t.namespace][t.value]=[]),r.callbacks[t.namespace][t.value].push(e)}),this}off(t){const i=this;if(void 0===t||""===t)return console.warn("wrong name"),!1;const e=this.resolveNames(t);return e.forEach(function(t){var e=i.resolveName(t);if("base"!==e.namespace&&""===e.value)delete i.callbacks[e.namespace];else if("base"===e.namespace)for(const r in i.callbacks)i.callbacks[r]instanceof Object&&i.callbacks[r][e.value]instanceof Array&&(delete i.callbacks[r][e.value],0===Object.keys(i.callbacks[r]).length&&delete i.callbacks[r]);else i.callbacks[e.namespace]instanceof Object&&i.callbacks[e.namespace][e.value]instanceof Array&&(delete i.callbacks[e.namespace][e.value],0===Object.keys(i.callbacks[e.namespace]).length&&delete i.callbacks[e.namespace])}),this}trigger(t,e=[]){if(void 0===t||""===t)return console.warn("wrong name"),!1;const r=this;const i=e instanceof Array?e:[];let n=this.resolveNames(t);n=this.resolveName(n[0]),setTimeout(()=>{if("base"===n.namespace)for(const t in r.callbacks){if(r.callbacks[t]instanceof Object&&r.callbacks[t][n.value]instanceof Array)r.callbacks[t][n.value].forEach(function(t){t.apply(r,i)});else if(this.callbacks[n.namespace]instanceof Object){if(""===n.value)return console.warn("wrong name"),this;r.callbacks[n.namespace][n.value].forEach(function(t){t.apply(r,i)})}return null}},100)}resolveNames(t){let e=t;return e=e.replace(/[^a-zA-Z0-9 ,/.]/g,""),e=e.replace(/[,/]+/g," "),e=e.split(" "),e}resolveName(t){const e={};var r=t.split(".");return e.original=t,e.value=r[0],e.namespace="base",1<r.length&&""!==r[1]&&(e.namespace=r[1]),e}}function ur(t){return t instanceof ArrayBuffer&&(t=new Uint8Array(t)),new TextDecoder("utf-8").decode(t)}var fr=new DOMParser;class dr{constructor(t){this.capacity=t,this.fragment_list=[],this.imageArray=[],this.cur_fragment=new mr(t),this.fragment_list.push(this.cur_fragment)}write(t){this.cur_fragment.write(t)||(this.cur_fragment=new mr(this.capacity),this.fragment_list.push(this.cur_fragment),this.cur_fragment.write(t))}get(t){for(var e=0;e<this.fragment_list.length;){var r=this.fragment_list[e];if(t<r.size)return r.get(t);t-=r.size,e+=1}return null}size(){for(var t=0,e=0;e<this.fragment_list.length;e++)t+=this.fragment_list[e].size;return t}shrink(){for(var t=new Uint8Array(this.size()),e=0,r=0;r<this.fragment_list.length;r++){var i=this.fragment_list[r];i.full()?t.set(i.buffer,e):t.set(i.buffer.slice(0,i.size),e),e+=i.size}return t}}class mr{constructor(t){this.buffer=new Uint8Array(t),this.capacity=t,this.size=0}write(t){return!(this.size>=this.capacity)&&(this.buffer[this.size]=t,this.size+=1,!0)}full(){return this.size===this.capacity}get(t){return this.buffer[t]}}class pr{constructor(t){this.render_image=(o,s)=>new Promise((r,e)=>{var i=o[s],t=+i.getAttribute("recindex"),n=this.read_image(t-1),t=new FileReader;t.onload=t=>{var e;i.src=null===(e=t.target)||void 0===e?void 0:e.result,r(null===(t=t.target)||void 0===t?void 0:t.result)},t.onerror=function(t){e(t)},t.readAsDataURL(n)}),this.view=new DataView(t),this.buffer=this.view.buffer,this.offset=0,this.header=null}parse(){}getUint8(){var t=this.view.getUint8(this.offset);return this.offset+=1,t}getUint16(){var t=this.view.getUint16(this.offset);return this.offset+=2,t}getUint32(){var t=this.view.getUint32(this.offset);return this.offset+=4,t}getStr(t){var e=ur(this.buffer.slice(this.offset,this.offset+t));return this.offset+=t,e}skip(t){this.offset+=t}setoffset(t){this.offset=t}get_record_extrasize(t,e){for(var r,i,n,o=t.length-1,s=0,a=15;0<a;a--)e&1<<a&&(i=(r=this.buffer_get_varlen(t,o))[0],n=r[1],o=r[2],o-=i-n,s+=i);return 1&e&&(s+=1+(3&t[o])),s}buffer_get_varlen(t,e){for(var r=0,i=0,n=0,o=0;;0){var s=t[e];if(i|=(127&s)<<o,o+=7,r+=1,--e,4<=(n+=1)||0<(128&s))break}return[i,r,e]}read_text(){for(var t=this.palm_header.record_count,e=[],r=1;r<=t;r++)e.push(this.read_text_record(r));return ur(function(e){var r=0;for(let t=0;t<e.length;t++){var i=e[t];r+=i.length}var n=new Uint8Array(r),o=0;for(let t=0;t<e.length;t++)i=e[t],n.set(i,o),o+=i.length;return n}(e))}read_text_record(t){var e=this.mobi_header.extra_flags,r=this.reclist[t].offset,i=this.reclist[t+1].offset,t=new Uint8Array(this.buffer.slice(r,i)),e=this.get_record_extrasize(t,e),t=new Uint8Array(this.buffer.slice(r,i-e));return 2!==this.palm_header.compression?t:function(t){for(var e=t.length,r=0,i=new dr(t.length);r<e;){var n=t[r];if(r+=1,0===n)i.write(n);else if(n<=8){for(var o=r;o<r+n;o++)i.write(t[o]);r+=n}else if(n<=127)i.write(n);else if(n<=191){var s=t[r];r+=1;var a=(n<<8|s)>>3&2047,h=3+(7&s),l=i.size();for(let t=0;t<h;t++)i.write(i.get(l-a)),l+=1}else i.write(32),i.write(128^n)}return i}(t).shrink()}read_image(t){var e=this.mobi_header.first_image_idx,r=this.reclist[e+t].offset,t=this.reclist[e+t+1].offset,t=new Uint8Array(this.buffer.slice(r,t));return new Blob([t.buffer])}load(){this.header=this.load_pdbheader(),this.reclist=this.load_reclist(),this.load_record0()}load_pdbheader(){var t={};return t.name=this.getStr(32),t.attr=this.getUint16(),t.version=this.getUint16(),t.ctime=this.getUint32(),t.mtime=this.getUint32(),t.btime=this.getUint32(),t.mod_num=this.getUint32(),t.appinfo_offset=this.getUint32(),t.sortinfo_offset=this.getUint32(),t.type=this.getStr(4),t.creator=this.getStr(4),t.uid=this.getUint32(),t.next_rec=this.getUint32(),t.record_num=this.getUint16(),t}load_reclist(){for(var t=[],e=0;e<this.header.record_num;e++){var r={};r.offset=this.getUint32(),r.attr=this.getUint32(),t.push(r)}return t}load_record0(){this.palm_header=this.load_record0_header(),this.mobi_header=this.load_mobi_header()}load_record0_header(){var t={},e=this.reclist[0];return this.setoffset(e.offset),t.compression=this.getUint16(),this.skip(2),t.text_length=this.getUint32(),t.record_count=this.getUint16(),t.record_size=this.getUint16(),t.encryption_type=this.getUint16(),this.skip(2),t}load_mobi_header(){var t={},e=this.offset;return t.identifier=this.getUint32(),t.header_length=this.getUint32(),t.mobi_type=this.getUint32(),t.text_encoding=this.getUint32(),t.uid=this.getUint32(),t.generator_version=this.getUint32(),this.skip(40),t.first_nonbook_index=this.getUint32(),t.full_name_offset=this.getUint32(),t.full_name_length=this.getUint32(),t.language=this.getUint32(),t.input_language=this.getUint32(),t.output_language=this.getUint32(),t.min_version=this.getUint32(),t.first_image_idx=this.getUint32(),t.huff_rec_index=this.getUint32(),t.huff_rec_count=this.getUint32(),t.datp_rec_index=this.getUint32(),t.datp_rec_count=this.getUint32(),t.exth_flags=this.getUint32(),this.skip(36),t.drm_offset=this.getUint32(),t.drm_count=this.getUint32(),t.drm_size=this.getUint32(),t.drm_flags=this.getUint32(),this.skip(8),this.skip(4),this.skip(46),t.extra_flags=this.getUint16(),this.setoffset(e+t.header_length),t}load_exth_header(){return{}}extractContent(t){var e=document.createElement("span");return e.innerHTML=t,e.textContent||e.innerText}render(){return new Promise((r,t)=>n(this,void 0,void 0,function*(){this.load();var t=this.read_text(),t=fr.parseFromString(t,"text/html").documentElement,e=t.getElementsByTagName("img");for(let t=0;t<e.length;t++)yield this.render_image(e,t);r(t)}))}}class gr{constructor(t){this.bookStr=t,this.chapterList=[],this.chapterDocList=[],this.bookDoc=(new DOMParser).parseFromString(this.bookStr,"text/html"),this.chapterDomList=[]}getChapter(){let e=[];this.chapterDomList=Array.from(this.bookDoc.getElementsByTagName("h1"));for(let t=0;t<this.chapterDomList.length;t++){var r=Math.floor(9e5*Math.random())+1e5;this.chapterList.push({label:this.chapterDomList[t]?-1===e.lastIndexOf(this.chapterDomList[t].innerText)?this.chapterDomList[t].innerText:e[e.lastIndexOf(this.chapterDomList[t].innerText)]+"#"+t:"Forword",id:"title"+r,href:"#title"+r,subitems:[]}),e.push(this.chapterList[t].label)}for(let t=0;t<this.chapterDomList.length;t++){this.chapterDomList[t].id=this.chapterList[t].id;var i=document.createElement("span"),n=document.createTextNode("pagebreak");i.appendChild(n),this.chapterDomList[t].parentNode.insertBefore(i,this.chapterDomList[t])}return this.chapterList}getChapterDoc(){var e,r=this.bookDoc.body.innerHTML.split("<span>pagebreak</span>").filter(t=>t.trim());for(let t=0;t<r.length;t++)r.length>this.chapterList.length&&0===t&&(e=Math.floor(9e5*Math.random())+1e5,this.chapterList.unshift({label:"Forword#"+t,id:"title"+e,href:"#title"+e,subitems:[]})),this.chapterDocList.push({title:this.chapterList[t].label,text:r[t]});return this.chapterDocList}}const br={svg:"image/svg+xml",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",zip:"application/zip",rar:"application/x-rar-compressed","7z":"application/x-7z-compressed",tar:"application/x-tar",html:"text/html",htm:"text/html",xml:"text/xml",xhtml:"application/xhtml+xml"};class vr{constructor(t,e,r,i,n){this.fileNameList=t,this.zip=e,this.bookStr="",this.format=n,this.bookDoc=null,this.mode=r,this.chapterList=[],this.extension=this.fileNameList[0].split(".").reverse()[0],this.element=i,this.getBookStr()}getBookStr(){let r=document.createElement("div");var i="single"===this.mode?1:2;for(let e=0;e<this.fileNameList.length;e++){let t=document.createElement("img");t.id=e+"",t.setAttribute("style",`width: ${"scroll"===this.mode?this.element.clientWidth:(this.element.clientWidth-88)/i}px;max-height:${"scroll"===this.mode?"inherit":this.element.clientHeight}px`),r.appendChild(t)}this.bookDoc=r}getChapter(){for(let t=0;t<this.fileNameList.length;t++)this.chapterList.push({label:this.fileNameList[t],id:t+"",href:"#"+t,subitems:[]});return this.chapterList}getImgRatio(){return this.extension=this.fileNameList[0].split(".").reverse()[0],new Promise((r,t)=>n(this,void 0,void 0,function*(){var t=new Image;t.onload=function(){r(t.height/t.width)};let e;e="cbr"===this.format?this.zip.decompress(this.fileNameList[0]):"cbt"===this.format?this.zip[Ze.findLastIndex(this.zip,{name:this.fileNameList[0]})].buffer:yield this.zip.file(this.fileNameList[0]).async("arraybuffer"),t.src="data:"+br[this.extension.toLowerCase()]+";base64,"+this.base64ArrayBuffer(e)}))}renderComic(){window.frames[0].document.body.innerHTML=this.bookDoc.outerHTML}renderImage(e){return n(this,void 0,void 0,function*(){if(this.extension=this.fileNameList[0].split(".").reverse()[0],window.frames[0].document.getElementById(e+"")&&!window.frames[0].document.getElementById(e+"").src){let t;t="cbr"===this.format?this.zip.decompress(this.fileNameList[e]):"cbt"===this.format?this.zip[Ze.findLastIndex(this.zip,{name:this.fileNameList[e]})].buffer:yield this.zip.file(this.fileNameList[e]).async("arraybuffer"),window.frames[0].document.getElementById(e+"")&&(window.frames[0].document.getElementById(e+"").src="data:"+br[this.extension.toLowerCase()]+";base64,"+this.base64ArrayBuffer(t))}})}base64ArrayBuffer(t){for(var e,r="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=new Uint8Array(t),o=n.byteLength,t=o%3,s=o-t,a=0;a<s;a+=3)r+=i[(16515072&(e=n[a]<<16|n[a+1]<<8|n[a+2]))>>18]+i[(258048&e)>>12]+i[(4032&e)>>6]+i[63&e];return 1==t?r+=i[(252&(e=n[s]))>>2]+i[(3&e)<<4]+"==":2==t&&(r+=i[(64512&(e=n[s]<<8|n[1+s]))>>10]+i[(1008&e)>>4]+i[(15&e)<<2]+"="),r}}const yr=(t,e)=>{0<e&&0<window.frames[0].document.body.scrollLeft?window.frames[0].document.body.scrollLeft-=t.offsetWidth+88:0<e&&0===window.frames[0].document.body.scrollLeft||e<0&&(window.frames[0].document.body.scrollLeft+=t.offsetWidth+88)},wr=(t,e,r="")=>{var i=r||parseInt(s.getKookitConfig("count"))||0;i?(r=Array.from(window.frames[0].document.body.querySelectorAll("img"))[i],"scroll"!==e?window.frames[0].document.body.scrollTo(i&&r?r.offsetLeft:0,0):t.scrollTo(0,i&&r?r.offsetTop:0)):("scroll"!==e?window.frames[0].document.body:t).scrollTo(0,0)};window.e=window.eval,window.a=window.atob,t.Azw3Render=class extends cr{constructor(t,e){super(),this.azw3Buffer=t,this.mode=e,this.chapterList=[],this.chapterDocList=[],this.bookStr="",this.element=""}renderTo(i){return n(this,void 0,void 0,function*(){return new Promise((r,t)=>n(this,void 0,void 0,function*(){if(yield f()){var e=(yield new pr(this.azw3Buffer).render()).outerHTML;this.bookStr=e,this.element=i;let t=new lr(this.bookStr);this.chapterList=t.getChapter(),this.chapterDocList=t.getChapterDoc();e=s.getKookitConfig("chapterTitle")||this.chapterDocList[0].title;Xe(i),Ye(i,this.mode),ir(e,this.chapterDocList,this.element,this.mode),this.trigger("rendered"),r()}else r()}))})}getChapter(){return this.chapterList}getPageSize(){return{width:window.frames[0].document.body.scrollWidth,height:window.frames[0].document.body.scrollHeight}}goToChapter(t){ir(t,this.chapterDocList,this.element,this.mode),this.trigger("rendered")}goToPosition(t,e,r){ir(e,this.chapterDocList,this.element,this.mode),nr(this.element,this.mode,t,r),this.trigger("rendered")}prev(){"scroll"===this.mode||0===window.frames[0].document.body.scrollLeft?rr(this.element,this.chapterList,this.chapterDocList,this.mode):er(this.element,this.chapterList,this.chapterDocList,this.mode,1),or(this.element,this.mode),this.trigger("rendered")}next(){Math.abs(window.frames[0].document.body.scrollWidth-window.frames[0].document.body.scrollLeft-window.frames[0].document.body.clientWidth)<10||"scroll"===this.mode?sr(this.element,this.chapterList,this.chapterDocList,this.mode):er(this.element,this.chapterList,this.chapterDocList,this.mode,-1),or(this.element,this.mode),this.trigger("rendered")}record(){or(this.element,this.mode)}getPosition(){return{text:s.getKookitConfig("text"),chapterTitle:s.getKookitConfig("chapterTitle"),count:s.getKookitConfig("count")}}setStyle(t){window.frames[0].document.body.setAttribute("style",t+window.frames[0].document.body.getAttribute("style"))}},t.ComicRender=class extends cr{constructor(t,e,r,i){super(),this.mode=r,this.format=i,this.zip=e,this.dataSource=t,this.element="",this.parser="",this.chapterList=[],this.largestId=parseInt(s.getKookitConfig("count"))||0}renderTo(o,s=0){return new Promise((t,e)=>n(this,void 0,void 0,function*(){if(yield f()){this.element=o,Xe(o),this.parser=new vr(this.dataSource,this.zip,this.mode,this.element,this.format),this.chapterList=this.parser.getChapter(),this.parser.renderComic(),this.renderImage(s);var r,i=yield this.parser.getImgRatio(),n=window.frames[0].document.getElementById(s+"").clientWidth*i;let e=window.frames[0].document.getElementsByTagName("img");for(let t=0;t<e.length;t++)"scroll"===this.mode?e[t].style.height=n+"px":(r="single"===this.mode?1:2,n>this.element.clientHeight?(e[t].style.height=this.element.clientHeight+"px",e[t].style.width=this.element.clientHeight/i+"px",e[t].style.paddingLeft=(this.element.clientWidth-("single"===this.mode?0:88))/2/r-this.element.clientHeight/i/2+"px"):(e[t].style.height=n+"px",e[t].style.marginTop=this.element.clientHeight/2-n/2+"px"));Ye(o,this.mode),Qe(o,this.mode),this.trigger("rendered"),t()}else t()}))}getPageSize(){return{width:window.frames[0].document.body.scrollWidth,height:window.frames[0].document.body.scrollHeight}}renderImage(t){this.parser.renderImage(t-1),this.parser.renderImage(t),this.parser.renderImage(t+1)}getChapter(){return this.chapterList}goToPosition(t,e,r){wr(this.element,this.mode,r)}goToChapter(t){wr(this.element,this.mode,this.dataSource.indexOf(t)+""),this.renderImage(this.dataSource.indexOf(t))}record(){or(this.element,this.mode);var t=parseInt(s.getKookitConfig("count"))||0;console.log(t),this.parser.renderImage(t-1),this.parser.renderImage(t),this.parser.renderImage(t+1)}prev(){var t=parseInt(s.getKookitConfig("count"))||0;console.log(t),this.parser.renderImage(t),this.parser.renderImage(t-1),this.parser.renderImage(t-2),yr(this.element,1),or(this.element,this.mode)}next(){var t=parseInt(s.getKookitConfig("count"))||0;console.log(t),this.parser.renderImage(t),this.parser.renderImage(t+1),this.parser.renderImage(t+2),this.parser.renderImage(t+3),this.parser.renderImage(t+4),yr(this.element,-1),or(this.element,this.mode)}getPosition(){return{text:s.getKookitConfig("text"),chapterTitle:s.getKookitConfig("chapterTitle"),count:s.getKookitConfig("count")}}setStyle(t){window.frames[0].document.body.setAttribute("style",t+window.frames[0].document.body.getAttribute("style"))}},t.MobiRender=class extends cr{constructor(t,e){super(),this.mobiBuffer=t,this.mode=e,this.chapterList=[],this.chapterDocList=[],this.bookStr="",this.element=""}renderTo(i){return new Promise((r,t)=>n(this,void 0,void 0,function*(){if(yield f()){var e=(yield new pr(this.mobiBuffer).render()).outerHTML;this.bookStr=e,this.element=i;let t=new hr(this.bookStr);this.chapterDocList=t.getChapterDoc(),this.chapterList=t.getChapter();e=s.getKookitConfig("chapterTitle")||this.chapterDocList[0].title;Xe(i),Ye(i,this.mode),ir(e,this.chapterDocList,this.element,this.mode),this.trigger("rendered"),r()}else r()}))}getPageSize(){return{width:window.frames[0].document.body.scrollWidth,height:window.frames[0].document.body.scrollHeight}}getChapter(){return this.chapterList}goToChapter(t){ir(t,this.chapterDocList,this.element,this.mode),this.trigger("rendered")}goToPosition(t,e,r){ir(e,this.chapterDocList,this.element,this.mode),nr(this.element,this.mode,t,r),this.trigger("rendered")}prev(){"scroll"===this.mode||0===window.frames[0].document.body.scrollLeft?rr(this.element,this.chapterList,this.chapterDocList,this.mode):er(this.element,this.chapterList,this.chapterDocList,this.mode,1),this.trigger("rendered"),or(this.element,this.mode)}next(){Math.abs(window.frames[0].document.body.scrollWidth-window.frames[0].document.body.scrollLeft-window.frames[0].document.body.clientWidth)<10||"scroll"===this.mode?sr(this.element,this.chapterList,this.chapterDocList,this.mode):er(this.element,this.chapterList,this.chapterDocList,this.mode,-1),this.trigger("rendered"),or(this.element,this.mode)}record(){or(this.element,this.mode)}getPosition(){return{text:s.getKookitConfig("text"),chapterTitle:s.getKookitConfig("chapterTitle"),count:s.getKookitConfig("count")}}setStyle(t){window.frames[0].document.body.setAttribute("style",t+window.frames[0].document.body.getAttribute("style"))}},t.StrRender=class extends cr{constructor(t,e){super(),this.bookStr=t,this.mode=e,this.chapterList=[],this.chapterDocList=[],this.element=""}renderTo(i){return new Promise((r,t)=>n(this,void 0,void 0,function*(){if(yield f()){this.element=i;let t=new lr(this.bookStr);this.chapterList=t.getChapter(),this.chapterDocList=t.getChapterDoc();var e=s.getKookitConfig("chapterTitle")||this.chapterDocList[0].title;Xe(i),ir(e,this.chapterDocList,this.element,this.mode),Ye(i,this.mode),this.trigger("rendered"),r()}else r()}))}getChapter(){return this.chapterList}getPageSize(){return{width:window.frames[0].document.body.scrollWidth,height:window.frames[0].document.body.scrollHeight}}goToChapter(t){ir(t,this.chapterDocList,this.element,this.mode),this.trigger("rendered")}goToPosition(t,e,r){ir(e,this.chapterDocList,this.element,this.mode),this.trigger("rendered"),nr(this.element,this.mode,t,r)}record(){or(this.element,this.mode)}prev(){"scroll"===this.mode||0===window.frames[0].document.body.scrollLeft?rr(this.element,this.chapterList,this.chapterDocList,this.mode):er(this.element,this.chapterList,this.chapterDocList,this.mode,1),this.trigger("rendered"),or(this.element,this.mode)}next(){Math.abs(window.frames[0].document.body.scrollWidth-window.frames[0].document.body.scrollLeft-window.frames[0].document.body.clientWidth)<10||"scroll"===this.mode?sr(this.element,this.chapterList,this.chapterDocList,this.mode):er(this.element,this.chapterList,this.chapterDocList,this.mode,-1),this.trigger("rendered"),or(this.element,this.mode)}getPosition(){return{text:s.getKookitConfig("text"),chapterTitle:s.getKookitConfig("chapterTitle"),count:s.getKookitConfig("count")}}setStyle(t){window.frames[0].document.body.setAttribute("style",t+window.frames[0].document.body.getAttribute("style"))}},t.TxtRender=class extends cr{constructor(t,e,r="utf-8"){super(),this.txtBuffer=t,this.encoding=r,this.mode=e,this.chapterList=[],this.chapterDocList=[],this.bookStr="",this.element=""}renderTo(i){return new Promise((r,t)=>n(this,void 0,void 0,function*(){if(yield f()){var e=(t=>{let e="",r=!1;var i;for(i of t.split("\n"))i.trim()&&(a(i.trim(),r)?((i.trim().startsWith("第")||i.trim().startsWith("Chapter")||i.trim().startsWith("CHAPTER"))&&(r=!0),e+=`<h1>${i}</h1>`):e+=`<p>${i}</p>`);return e})(new TextDecoder(this.encoding).decode(this.txtBuffer));this.bookStr=e,this.element=i;let t=new gr(this.bookStr);this.chapterList=t.getChapter(),this.chapterDocList=t.getChapterDoc();e=s.getKookitConfig("chapterTitle")||this.chapterDocList[0].title;Xe(i),Ye(i,this.mode),ir(e,this.chapterDocList,this.element,this.mode),this.trigger("rendered"),r()}else r()}))}getChapter(){return this.chapterList}goToChapter(t){ir(t,this.chapterDocList,this.element,this.mode),this.trigger("rendered")}getPageSize(){return{width:window.frames[0].document.body.scrollWidth,height:window.frames[0].document.body.scrollHeight}}goToPosition(t,e,r){ir(e,this.chapterDocList,this.element,this.mode),nr(this.element,this.mode,t,r),this.trigger("rendered")}record(){or(this.element,this.mode)}prev(){"scroll"===this.mode||0===window.frames[0].document.body.scrollLeft?rr(this.element,this.chapterList,this.chapterDocList,this.mode):er(this.element,this.chapterList,this.chapterDocList,this.mode,1),this.trigger("rendered"),or(this.element,this.mode)}next(){Math.abs(window.frames[0].document.body.scrollWidth-window.frames[0].document.body.scrollLeft-window.frames[0].document.body.clientWidth)<10||"scroll"===this.mode?sr(this.element,this.chapterList,this.chapterDocList,this.mode):er(this.element,this.chapterList,this.chapterDocList,this.mode,-1),this.trigger("rendered"),or(this.element,this.mode)}getPosition(){return{text:s.getKookitConfig("text"),chapterTitle:s.getKookitConfig("chapterTitle"),count:s.getKookitConfig("count")}}setStyle(t){window.frames[0].document.body.setAttribute("style",t+window.frames[0].document.body.getAttribute("style"))}},Object.defineProperty(t,"__esModule",{value:!0})});
